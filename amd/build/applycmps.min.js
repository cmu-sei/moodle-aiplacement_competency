define("aiplacement_classifyassist/applycmps",["core/modal","core/modal_factory","core/modal_events","core/templates","core/str","core/ajax","jquery","core/notification"],(function(Modal,ModalFactory,ModalEvents,Templates,Str,Ajax,$,Notification){var toArray=function(nl){return Array.prototype.slice.call(nl||[])};function showNoticesFrom(key,headings){var raw=null;try{raw=sessionStorage.getItem(key)}catch(e){}if(raw){try{sessionStorage.removeItem(key)}catch(e){}var data={};try{data=JSON.parse(raw)||{}}catch(e){}var added=Array.isArray(data.added)?data.added:[],exists=Array.isArray(data.exists)?data.exists:[],failed=Array.isArray(data.failed)?data.failed:[],jobs=[],esc=function(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},renderList=function(items){return'<ul class="mb-0 mt-1">'+items.map((function(t){return"<li>"+esc(t)+"</li>"})).join("")+"</ul>"};added.length&&jobs.push(Str.get_string(headings.added.key,headings.added.comp,{count:added.length}).catch((function(){return headings.added.fallback(added.length)})).then((function(h){Notification.addNotification({type:"success",message:"<div>"+esc(h)+"</div>"+renderList(added)})}))),exists.length&&jobs.push(Str.get_string(headings.exists.key,headings.exists.comp,{count:exists.length}).catch((function(){return headings.exists.fallback(exists.length)})).then((function(h){Notification.addNotification({type:"warning",message:"<div>"+esc(h)+"</div>"+renderList(exists)})}))),failed.length&&jobs.push(Str.get_string(headings.failed.key,headings.failed.comp,{count:failed.length}).catch((function(){return headings.failed.fallback(failed.length)})).then((function(h){Notification.addNotification({type:"error",message:"<div>"+esc(h)+"</div>"+renderList(failed)})}))),Promise.allSettled(jobs)}}var norm=function(s){return(null===s?"":String(s)).toLowerCase().trim()};var openModal=function(values){return Str.get_string("applycmps_title","aiplacement_classifyassist").then((function(title){return Templates.render("aiplacement_classifyassist/applycmps_modal",{competencies:values.competencies||[],hascompetencies:!(!values.competencies||!values.competencies.length)}).then((function(html,js){var hasNew,api={create:(hasNew=Modal&&"function"==typeof Modal.create)?Modal.create.bind(Modal):ModalFactory&&ModalFactory.create.bind(ModalFactory),types:hasNew&&(Modal.types||Modal.TYPE)||ModalFactory&&ModalFactory.types||null};if(!api.create)throw new Error("No modal API available");var opts={title:title,body:html,large:!0};return api.types&&api.types.SAVE_CANCEL&&(opts.type=api.types.SAVE_CANCEL),api.create(opts).then((function(modal){var $root;return js&&Templates.runTemplateJS(js),($root=modal.getRoot()).on("click",'[data-action="selectall"]',(function(e){e.preventDefault();var sec=e.currentTarget.closest(".aiplacement-applycmps-section");sec&&toArray(sec.querySelectorAll('input[type="checkbox"]')).forEach((function(cb){cb.checked=!0}))})),$root.on("click",'[data-action="clearall"]',(function(e){e.preventDefault();var sec=e.currentTarget.closest(".aiplacement-applycmps-section");sec&&toArray(sec.querySelectorAll('input[type="checkbox"]')).forEach((function(cb){cb.checked=!1}))})),$root.on("click",'[data-action="apply-inline"]',(function(e){e.preventDefault(),$root.trigger(ModalEvents.save)})),new Promise((function(resolve,reject){modal.getRoot().on(ModalEvents.save,(function(){try{var picked=function(root){return{competencies:toArray(root.querySelectorAll('.aiplacement-applycmps-section[data-section="competencies"] input[type="checkbox"]:checked')).map((function(cb){var row=cb.closest("label"),span=row&&row.querySelector("span");return span?span.textContent.trim():null})).filter(Boolean)}}(modal.getRoot()[0]);modal.getRoot().data("selection",picked),sessionStorage.setItem("aiplacement_applycmps:last",JSON.stringify(picked)),function(frameworkId,picked){return new Promise((function(resolve,reject){Ajax.call([{methodname:"core_competency_list_competencies",args:{filters:[{column:"competencyframeworkid",value:String(frameworkId)}],sort:"shortname",order:"ASC",skip:0,limit:0}}])[0].done((function(response){var list=Array.isArray(response)?response:response.competencies||[],byIdnumber=new Map,byShortExact=new Map;list.forEach((function(c){var idn=norm(c.idnumber),sn=norm(c.shortname);idn&&byIdnumber.set(idn,c),sn&&byShortExact.set(sn,c)}));var matches=[].concat(picked.competencies||[]).map((function(str){var original=str||"",parts=original.split(" - "),code=norm(parts[0]||""),name=norm(parts.slice(1).join(" - ")),comp=null;return code&&byIdnumber.has(code)&&(comp=byIdnumber.get(code)),!comp&&name&&byShortExact.has(name)&&(comp=byShortExact.get(name)),!comp&&name&&(comp=list.find((function(c){return norm(c.description).includes(name)}))),!comp&&name&&(comp=list.find((function(c){return norm(c.shortname).includes(name)}))),comp?{input:original,id:comp.id,idnumber:comp.idnumber,shortname:comp.shortname}:{input:original,id:null}})),matchedIds=matches.filter((function(m){return null!==m.id})).map((function(m){return m.id}));resolve({matches:matches,matchedIds:matchedIds,list:list})})).fail(reject)}))}(String($("dd[data-frameworkid]").data("frameworkid")||"0"),picked).then((function(res){var sel=modal.getRoot().data("selection")||{};sel.matchedCompetencyIds=res.matchedIds,modal.getRoot().data("selection",sel);var m,all=Array.isArray(res.matches)?res.matches:[],matched=all.filter((function(m){return m&&null!==m.id})),unmatched=all.filter((function(m){return!m||null===m.id})),unmatchedLabels=unmatched.map((function(m){return m&&m.input?String(m.input).trim():""})).filter(Boolean),courseId=(m=(document.body&&document.body.className||"").match(/(?:^|\s)course-(\d+)(?:\s|$)/))?parseInt(m[1],10):null;if(!courseId)return Str.get_string("notify_nocourseid","aiplacement_classifyassist").then((function(msg){Notification.addNotification({type:"warning",message:msg})})),resolve(picked),void modal.hide();var calls=res.matchedIds.map((function(id){return{methodname:"core_competency_add_competency_to_course",args:{courseid:courseId,competencyid:id}}})),reqs=Ajax.call(calls);Promise.all(reqs.map((function(p,idx){return Promise.resolve(p).then((function(r){return{id:res.matchedIds[idx],result:r}})).catch((function(e){return{id:res.matchedIds[idx],error:e}}))}))).then((function(outcomes){var byId=new Map;matched.forEach((function(m){m.id&&byId.set(m.id,m)}));var added=[],exists=[],failed=[];outcomes.forEach((function(o){o.error?failed.push(o.id):!1===o.result?exists.push(o.id):!0===o.result||1===o.result||"1"===o.result?added.push(o.id):(o.result?added:exists).push(o.id)}));var nameOf=function(id){var m=byId.get(id);return m&&(m.shortname||m.input)||"ID "+id};!function(added,exists,failed){try{sessionStorage.setItem("aiplacement:coursePostReloadNotices",JSON.stringify({added:added||[],exists:exists||[],failed:failed||[]}))}catch(e){}}(added.map(nameOf),exists.map(nameOf),failed.map(nameOf).concat(unmatchedLabels));var qs,cmid=(qs=new URLSearchParams(window.location.search),Number(qs.get("update")||0)),toLink=Array.from(new Set([].concat(added,exists))),linkPromise=Promise.resolve();if(cmid>0&&toLink.length){var byIdName=new Map;matched.forEach((function(m){m&&m.id&&byIdName.set(m.id,m.shortname||m.input||"ID "+m.id)})),linkPromise=Promise.all(toLink.map((function(id){return function(cmid,competencyId){return Ajax.call([{methodname:"aiplacement_classifyassist_add_cm_competency",args:{cmid:cmid,competencyid:competencyId}}])[0]}(cmid,id).then((function(ok){return{id:id,status:ok?"added":"exists"}})).catch((function(){return{id:id,status:"failed"}}))}))).then((function(results){var addedIds=[],existsIds=[],failedIds=[];results.forEach((function(r){"added"===r.status?addedIds.push(r.id):"exists"===r.status?existsIds.push(r.id):failedIds.push(r.id)})),function(added,exists,failed){try{sessionStorage.setItem("aiplacement:cmPostReloadNotices",JSON.stringify({added:added||[],exists:exists||[],failed:failed||[]}))}catch(e){}}(addedIds.map((function(id){return byIdName.get(id)||"ID "+id})),existsIds.map((function(id){return byIdName.get(id)||"ID "+id})),failedIds.map((function(id){return byIdName.get(id)||"ID "+id})))}))}linkPromise.then((function(){window.location.reload()}))})).catch((function(err){Notification.exception(err),resolve(picked),modal.hide()}))})).catch(reject)}catch(err){reject(err)}})),modal.show()}))}))}))}))},handleClick=function(btn){var card=btn.closest(".card-text.content");if(card){var values=function(root){var out={competencies:[]};if(!root)return out;var dd=root.querySelector('dd[data-section="competencies"]');return dd?(out.competencies=toArray(dd.querySelectorAll("li")).map((function(li){return(li.innerText||"").trim()})).filter(Boolean).filter((function(s){return"none"!==s.toLowerCase()})),out):out}(card.querySelector(".course-assist-response-content"));openModal(values).then((function(edited){if(edited){var contentEl=card.querySelector('[id^="course-assist-response-content-"]');!function(payload,context){var ev;try{ev=new CustomEvent("aiplacement_classifyassist:apply",{detail:payload,bubbles:!0})}catch(e){(ev=document.createEvent("CustomEvent")).initCustomEvent("aiplacement_classifyassist:apply",!0,!1,payload)}(context||document).dispatchEvent(ev)}({uniqid:contentEl?contentEl.id:null,action:"applycmps",values:edited},contentEl||document)}}))}};return showNoticesFrom("aiplacement:coursePostReloadNotices",{added:{key:"notify_course_added_heading",comp:"aiplacement_classifyassist",fallback:c=>"Course competencies added ("+c+")"},exists:{key:"notify_course_exists_heading",comp:"aiplacement_classifyassist",fallback:c=>"Already in course ("+c+")"},failed:{key:"notify_course_failed_heading",comp:"aiplacement_classifyassist",fallback:c=>"Failed to add to course (does not match selected framework) ("+c+")"}}),showNoticesFrom("aiplacement:cmPostReloadNotices",{added:{key:"notify_cm_added_heading",comp:"aiplacement_classifyassist",fallback:c=>"Added to activity ("+c+")"},exists:{key:"notify_cm_exists_heading",comp:"aiplacement_classifyassist",fallback:c=>"Already linked to activity ("+c+")"},failed:{key:"notify_cm_failed_heading",comp:"aiplacement_classifyassist",fallback:c=>"Failed to link to activity ("+c+")"}}),{init:function(){document.addEventListener("click",(function(e){var btn=e.target.closest('button[data-action="applycmps"]');btn&&(e.preventDefault(),handleClick(btn))}),{passive:!1})}}}));

//# sourceMappingURL=applycmps.min.js.map