define(["core/modal","core/modal_factory","core/modal_events","core/templates","core/str","core/ajax","jquery","core/notification"],function(t,n,o,a,s,m,r,l){var c=function(e){return Array.prototype.slice.call(e||[])},p="aiplacement:coursePostReloadNotices",f="aiplacement:cmPostReloadNotices";function e(e,t){var n=null;try{n=sessionStorage.getItem(e)}catch(e){}if(n){try{sessionStorage.removeItem(e)}catch(e){}e={};try{e=JSON.parse(n)||{}}catch(e){}var c=Array.isArray(e.added)?e.added:[],a=Array.isArray(e.exists)?e.exists:[],i=Array.isArray(e.failed)?e.failed:[],n=[],o=function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},r=function(e){return'<ul class="mb-0 mt-1">'+e.map(function(e){return"<li>"+o(e)+"</li>"}).join("")+"</ul>"};c.length&&n.push(s.get_string(t.added.key,t.added.comp,{count:c.length}).catch(function(){return t.added.fallback(c.length)}).then(function(e){l.addNotification({type:"success",message:"<div>"+o(e)+"</div>"+r(c)})})),a.length&&n.push(s.get_string(t.exists.key,t.exists.comp,{count:a.length}).catch(function(){return t.exists.fallback(a.length)}).then(function(e){l.addNotification({type:"warning",message:"<div>"+o(e)+"</div>"+r(a)})})),i.length&&n.push(s.get_string(t.failed.key,t.failed.comp,{count:i.length}).catch(function(){return t.failed.fallback(i.length)}).then(function(e){l.addNotification({type:"error",message:"<div>"+o(e)+"</div>"+r(i)})})),Promise.allSettled(n)}}var i=function(){var e=t&&"function"==typeof t.create;return{create:e?t.create.bind(t):n&&n.create.bind(n),types:e&&(t.types||t.TYPE)||n&&n.types||null}},u=function(e){var t={competencies:[]};return e&&(e=e.querySelector('dd[data-section="competencies"]'))&&(t.competencies=c(e.querySelectorAll("li")).map(function(e){return(e.innerText||"").trim()}).filter(Boolean).filter(function(e){return"none"!==e.toLowerCase()})),t},d=function(e){return{competencies:c(e.querySelectorAll('.aiplacement-applycmps-section[data-section="competencies"] input[type="checkbox"]:checked')).map(function(e){e=e.closest("label"),e=e&&e.querySelector("span");return e?e.textContent.trim():null}).filter(Boolean)}},y=function(t){t.on("click",'[data-action="selectall"]',function(e){e.preventDefault();e=e.currentTarget.closest(".aiplacement-applycmps-section");e&&c(e.querySelectorAll('input[type="checkbox"]')).forEach(function(e){e.checked=!0})}),t.on("click",'[data-action="clearall"]',function(e){e.preventDefault();e=e.currentTarget.closest(".aiplacement-applycmps-section");e&&c(e.querySelectorAll('input[type="checkbox"]')).forEach(function(e){e.checked=!1})}),t.on("click",'[data-action="apply-inline"]',function(e){e.preventDefault(),t.trigger(o.save)})},h=function(e){return(null===e?"":String(e)).toLowerCase().trim()},g=function(t,c){return new Promise(function(n,e){m.call([{methodname:"core_competency_list_competencies",args:{filters:[{column:"competencyframeworkid",value:String(t)}],sort:"shortname",order:"ASC",skip:0,limit:0}}])[0].done(function(e){var a=Array.isArray(e)?e:e.competencies||[],i=new Map,o=new Map;a.forEach(function(e){var t=h(e.idnumber),n=h(e.shortname);t&&i.set(t,e),n&&o.set(n,e)});var e=[].concat(c.competencies||[]).map(function(e){var e=e||"",t=e.split(" - "),n=h(t[0]||""),c=h(t.slice(1).join(" - ")),t=null;return(t=!(t=!(t=!(t=n&&i.has(n)?i.get(n):t)&&c&&o.has(c)?o.get(c):t)&&c?a.find(function(e){return h(e.description).includes(c)}):t)&&c?a.find(function(e){return h(e.shortname).includes(c)}):t)?{input:e,id:t.id,idnumber:t.idnumber,shortname:t.shortname}:{input:e,id:null}}),t=e.filter(function(e){return null!==e.id}).map(function(e){return e.id});n({matches:e,matchedIds:t,list:a})}).fail(e)})};var _=function(e){return s.get_string("applycmps_title","aiplacement_competency").then(function(c){return a.render("aiplacement_competency/applycmps_modal",{competencies:e.competencies||[],hascompetencies:!(!e.competencies||!e.competencies.length)}).then(function(e,t){var n=i();if(n.create)return e={title:c,body:e,large:!0},n.types&&n.types.SAVE_CANCEL&&(e.type=n.types.SAVE_CANCEL),n.create(e).then(function(i){return t&&a.runTemplateJS(t),y(i.getRoot()),new Promise(function(a,n){i.getRoot().on(o.save,function(){try{var e=i.getRoot()[0],c=d(e),t=(i.getRoot().data("selection",c),sessionStorage.setItem("aiplacement_applycmps:last",JSON.stringify(c)),String(r("dd[data-frameworkid]").data("frameworkid")||"0"));g(t,c).then(function(n){var e=i.getRoot().data("selection")||{},e=(e.matchedCompetencyIds=n.matchedIds,i.getRoot().data("selection",e),Array.isArray(n.matches)?n.matches:[]),u=e.filter(function(e){return e&&null!==e.id}),d=e.filter(function(e){return!e||null===e.id}).map(function(e){return e&&e.input?String(e.input).trim():""}).filter(Boolean),t=(e=(document.body&&document.body.className||"").match(/(?:^|\s)course-(\d+)(?:\s|$)/))?parseInt(e[1],10):null;t?(e=n.matchedIds.map(function(e){return{methodname:"core_competency_add_competency_to_course",args:{courseid:t,competencyid:e}}}),e=m.call(e),Promise.all(e.map(function(e,t){return Promise.resolve(e).then(function(e){return{id:n.matchedIds[t],result:e}}).catch(function(e){return{id:n.matchedIds[t],error:e}})})).then(function(e){function t(e){var t=n.get(e);return t&&(t.shortname||t.input)||"ID "+e}var n=new Map,c=(u.forEach(function(e){e.id&&n.set(e.id,e)}),[]),a=[],i=[],e=(e.forEach(function(e){(e.error?i:!1!==e.result&&(!0===e.result||1===e.result||"1"===e.result||e.result)?c:a).push(e.id)}),c.map(t)),o=a.map(t),r=i.map(t).concat(d);try{sessionStorage.setItem(p,JSON.stringify({added:e||[],exists:o||[],failed:r||[]}))}catch(e){}e=new URLSearchParams(window.location.search);var s,l=Number(e.get("update")||0),o=Array.from(new Set([].concat(c,a))),r=Promise.resolve();0<l&&o.length&&(s=new Map,u.forEach(function(e){e&&e.id&&s.set(e.id,e.shortname||e.input||"ID "+e.id)}),r=Promise.all(o.map(function(t){return m.call([{methodname:"aiplacement_competency_add_cm_competency",args:{cmid:l,competencyid:t}}])[0].then(function(e){return{id:t,status:e?"added":"exists"}}).catch(function(){return{id:t,status:"failed"}})})).then(function(e){var t=[],n=[],c=[],e=(e.forEach(function(e){("added"===e.status?t:"exists"===e.status?n:c).push(e.id)}),t.map(function(e){return s.get(e)||"ID "+e})),a=n.map(function(e){return s.get(e)||"ID "+e}),i=c.map(function(e){return s.get(e)||"ID "+e});try{sessionStorage.setItem(f,JSON.stringify({added:e||[],exists:a||[],failed:i||[]}))}catch(e){}})),r.then(function(){window.location.reload()})}).catch(function(e){l.exception(e),a(c),i.hide()})):(s.get_string("notify_nocourseid","aiplacement_competency").then(function(e){l.addNotification({type:"warning",message:e})}),a(c),i.hide())}).catch(n)}catch(e){n(e)}}),i.show()})});throw new Error("No modal API available")})})},v=function(t,e){var n;try{n=new CustomEvent("aiplacement_competency:apply",{detail:t,bubbles:!0})}catch(e){(n=document.createEvent("CustomEvent")).initCustomEvent("aiplacement_competency:apply",!0,!1,t)}(e||document).dispatchEvent(n)};return e(p,{added:{key:"notify_course_added_heading",comp:"aiplacement_competency",fallback:function(e){return"Course competencies added ("+e+")"}},exists:{key:"notify_course_exists_heading",comp:"aiplacement_competency",fallback:function(e){return"Already in course ("+e+")"}},failed:{key:"notify_course_failed_heading",comp:"aiplacement_competency",fallback:function(e){return"Failed to add to course (does not match selected framework) ("+e+")"}}}),e(f,{added:{key:"notify_cm_added_heading",comp:"aiplacement_competency",fallback:function(e){return"Added to activity ("+e+")"}},exists:{key:"notify_cm_exists_heading",comp:"aiplacement_competency",fallback:function(e){return"Already linked to activity ("+e+")"}},failed:{key:"notify_cm_failed_heading",comp:"aiplacement_competency",fallback:function(e){return"Failed to link to activity ("+e+")"}}}),{init:function(){document.addEventListener("click",function(e){var c,t=e.target.closest('button[data-action="applycmps"]');t&&(e.preventDefault(),c=(e=t).closest(".card-text.content"))&&(e=c.querySelector(".course-assist-response-content"),e=u(e),_(e).then(function(e){var t,n;e&&(n=(t=c.querySelector('[id^="course-assist-response-content-"]'))?t.id:null,v({uniqid:n,action:"applycmps",values:e},t||document))}))},{passive:!1})}}});
//# sourceMappingURL=applycmps.min.js.map