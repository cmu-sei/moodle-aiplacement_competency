define("aiplacement_classifyassist/applytsks",["core/modal","core/modal_factory","core/modal_events","core/templates","core/str","core/ajax","jquery","core/notification"],(function(Modal,ModalFactory,ModalEvents,Templates,Str,Ajax,$,Notification){var toArray=function(nl){return Array.prototype.slice.call(nl||[])},MAP={tasks:"tasks",skills:"skills",knowledge:"knowledge"},collectChecked=function(root){var pick=function(section){var sel='.aiplacement-applytsks-section[data-section="'+section+'"] input[type="checkbox"]:checked';return toArray(root.querySelectorAll(sel)).map((function(cb){var row=cb.closest("label"),span=row&&row.querySelector("span");return span?span.textContent.trim():null})).filter(Boolean)};return{tasks:pick("tasks"),skills:pick("skills"),knowledge:pick("knowledge")}},esc=function(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},renderList=function(items){return'<ul class="mb-0 mt-1">'+items.map((function(t){return"<li>"+esc(t)+"</li>"})).join("")+"</ul>"},norm=function(s){return(null==s?"":String(s)).toLowerCase().trim()},openModal=function(values){return Str.get_string("applytsks_title","aiplacement_classifyassist").then((function(title){return Templates.render("aiplacement_classifyassist/applytsks_modal",{tasks:values.tasks||[],skills:values.skills||[],knowledge:values.knowledge||[],hastasks:!(!values.tasks||!values.tasks.length),hasskills:!(!values.skills||!values.skills.length),hasknowledge:!(!values.knowledge||!values.knowledge.length)}).then((function(html,js){var hasNew,api={create:(hasNew=Modal&&"function"==typeof Modal.create)?Modal.create.bind(Modal):ModalFactory&&ModalFactory.create.bind(ModalFactory),types:hasNew&&(Modal.types||Modal.TYPE)||ModalFactory&&ModalFactory.types||null};if(!api.create)throw new Error("No modal API available");var opts={title:title,body:html,large:!0};return api.types&&api.types.SAVE_CANCEL&&(opts.type=api.types.SAVE_CANCEL),api.create(opts).then((function(modal){var $root;return js&&Templates.runTemplateJS(js),($root=modal.getRoot()).on("click",'[data-action="selectall"]',(function(e){e.preventDefault();var sec=e.currentTarget.closest(".aiplacement-applytsks-section");sec&&toArray(sec.querySelectorAll('input[type="checkbox"]')).forEach((function(cb){cb.checked=!0}))})),$root.on("click",'[data-action="clearall"]',(function(e){e.preventDefault();var sec=e.currentTarget.closest(".aiplacement-applytsks-section");sec&&toArray(sec.querySelectorAll('input[type="checkbox"]')).forEach((function(cb){cb.checked=!1}))})),$root.on("click",'[data-action="apply-inline"]',(function(e){e.preventDefault(),$root.trigger(ModalEvents.save)})),new Promise((function(resolve,reject){modal.getRoot().on(ModalEvents.save,(function(){try{var root=modal.getRoot()[0],picked=collectChecked(root);modal.getRoot().data("selection",picked),sessionStorage.setItem("aiplacement_applytsks:last",JSON.stringify(picked)),console.log("Selection saved:",picked),function(frameworkId,picked){return new Promise((function(resolve,reject){Ajax.call([{methodname:"core_competency_list_competencies",args:{filters:[{column:"competencyframeworkid",value:String(frameworkId)}],sort:"shortname",order:"ASC",skip:0,limit:0}}])[0].done((function(response){var list=Array.isArray(response)?response:response.competencies||[],byIdnumber=new Map,byShortExact=new Map;list.forEach((function(c){var idn=norm(c.idnumber),sn=norm(c.shortname);idn&&byIdnumber.set(idn,c),sn&&byShortExact.set(sn,c)}));var matches=[].concat(picked.tasks||[]).concat(picked.skills||[]).concat(picked.knowledge||[]).map((function(str){var original=str||"",parts=original.split(" - "),code=norm(parts[0]||""),name=norm(parts.slice(1).join(" - ")),comp=null;return code&&byIdnumber.has(code)&&(comp=byIdnumber.get(code)),!comp&&name&&byShortExact.has(name)&&(comp=byShortExact.get(name)),!comp&&name&&(comp=list.find((function(c){return norm(c.description).includes(name)}))),!comp&&name&&(comp=list.find((function(c){return norm(c.shortname).includes(name)}))),comp?{input:original,id:comp.id,idnumber:comp.idnumber,shortname:comp.shortname}:{input:original,id:null}})),matchedIds=matches.filter((function(m){return null!==m.id&&void 0!==m.id})).map((function(m){return m.id}));resolve({matches:matches,matchedIds:matchedIds,list:list})})).fail((function(err){reject(err)}))}))}(String($("dd[data-frameworkid]").data("frameworkid")||"0"),picked).then((function(res){var sel=modal.getRoot().data("selection")||{};sel.matchedCompetencyIds=res.matchedIds,modal.getRoot().data("selection",sel);var all=Array.isArray(res.matches)?res.matches:[],matched=all.filter((function(m){return m&&null!==m.id&&void 0!==m.id})),unmatched=all.filter((function(m){return!m||null===m.id||void 0===m.id})),unmatchedLabels=unmatched.map((function(m){return m&&m.input?String(m.input).trim():""})).filter(Boolean);console.log("Competency list:",res.list),console.log("Matched (with ids):",matched),console.log("Unmatched (no id):",unmatchedLabels),console.log("Matched competency IDs:",res.matchedIds);var m,courseId=(m=(document.body&&document.body.className||"").match(/(?:^|\s)course-(\d+)(?:\s|$)/))?parseInt(m[1],10):null,pickedNow=collectChecked(root);if(!courseId)return Str.get_string("notify_nocourseid","aiplacement_classifyassist").then((function(msg){Notification.addNotification({type:"warning",message:msg})})),resolve(pickedNow),void modal.hide();(function(courseId,competencyIds){if(!courseId||!Array.isArray(competencyIds)||0===competencyIds.length)return Promise.resolve([]);var calls=competencyIds.map((function(id){return{methodname:"core_competency_add_competency_to_course",args:{courseid:courseId,competencyid:id}}})),reqs=Ajax.call(calls);return Promise.all(reqs.map((function(p,idx){return Promise.resolve(p).then((function(res){return{id:competencyIds[idx],result:res}})).catch((function(err){return{id:competencyIds[idx],error:err}}))})))})(courseId,res.matchedIds).then((function(outcomes){var byId=new Map;matched.forEach((function(m){m.id&&byId.set(m.id,m)}));var added=[],exists=[],failed=[];outcomes.forEach((function(o){o.error?failed.push(o.id):!1===o.result?exists.push(o.id):!0===o.result||1===o.result||"1"===o.result?added.push(o.id):(o.result?added:exists).push(o.id)}));var nameOf=function(id){var m=byId.get(id);return m&&(m.shortname||m.input)||"ID "+id},addedNames=added.map(nameOf),existsNames=exists.map(nameOf),failedNames=failed.map(nameOf).concat(unmatchedLabels);added.length&&Str.get_string("notify_added_heading","aiplacement_classifyassist",{count:added.length}).then((function(heading){Notification.addNotification({type:"success",message:"<div>"+esc(heading)+"</div>"+renderList(addedNames)})})),exists.length&&Str.get_string("notify_exists_heading","aiplacement_classifyassist",{count:exists.length}).then((function(heading){Notification.addNotification({type:"warning",message:"<div>"+esc(heading)+"</div>"+renderList(existsNames)})})),failedNames.length&&Str.get_string("notify_failed_heading","aiplacement_classifyassist",{count:failedNames.length}).then((function(heading){Notification.addNotification({type:"error",message:"<div>"+esc(heading)+"</div>"+renderList(failedNames)})})),resolve(pickedNow),modal.hide()})).catch((function(err){console.error("Failed to add competencies to course:",err),Notification.exception(err),resolve(pickedNow),modal.hide()}))})).catch((function(err){console.error("Failed to list/match competencies:",err),reject(err)}))}catch(err){console.error(err),reject(err)}})),modal.show()}))}))}))}))},handleClick=function(btn){var card=btn.closest(".card-text.content");if(card){var values=function(root){var out={tasks:[],skills:[],knowledge:[]};if(!root)return out;var dl=root.querySelector("dl");return dl?(toArray(dl.querySelectorAll("dt")).forEach((function(dt){var key=MAP[(dt.textContent||"").trim().toLowerCase()];if(key){var dd=dt.nextElementSibling;dd&&"dd"===dd.tagName.toLowerCase()&&(out[key]=toArray(dd.querySelectorAll("li")).map((function(li){return(li.innerText||"").trim()})).filter(Boolean).filter((function(s){return"none"!==s.toLowerCase()})))}})),out):out}(card.querySelector(".course-assist-response-content"));openModal(values).then((function(edited){if(edited){var contentEl=card.querySelector('[id^="course-assist-response-content-"]');!function(payload,context){var ev;try{ev=new CustomEvent("aiplacement_classifyassist:apply",{detail:payload,bubbles:!0})}catch(e){(ev=document.createEvent("CustomEvent")).initCustomEvent("aiplacement_classifyassist:apply",!0,!1,payload)}(context||document).dispatchEvent(ev)}({uniqid:contentEl?contentEl.id:null,action:"applytsks",values:edited},contentEl||document)}}))}};return{init:function(){document.addEventListener("click",(function(e){var btn=e.target.closest('button[data-action="applytsks"]');btn&&(e.preventDefault(),handleClick(btn))}),{passive:!1})}}}));

//# sourceMappingURL=applytsks.min.js.map