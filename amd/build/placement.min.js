define("aiplacement_classifyassist/placement",["aiplacement_courseassist/placement","core/templates","core/ajax","core/notification","core/str"],(function(Base,Templates,Ajax,Notification,Str){return class extends Base{constructor(userId,contextId){super(userId,contextId),this.aiDrawerElement=document.querySelector("#ai-classify-drawer"),this.aiDrawerBodyElement=this.aiDrawerElement.querySelector(".ai-drawer-body"),this.aiDrawerCloseElement=this.aiDrawerElement.querySelector("#ai-classify-drawer-close"),this.aiDrawerCloseElement&&this.aiDrawerCloseElement.addEventListener("click",(e=>{e.preventDefault(),this.closeAIDrawer()})),this.registerExtraListener()}registerExtraListener(){document.addEventListener("click",(async e=>{if(!e.target.closest('[data-action="classify"]'))return;e.preventDefault(),this.openAIDrawer();let prompt="";const tex=document.querySelector("#id_introeditor");prompt=tex?tex.value.trim():this.getTextContent().trim(),prompt?await this.showSelectFramework(prompt):Notification.error("No content found to classify.")}))}async showSelectFramework(prompt){this.aiDrawerBodyElement.dataset.cancelled="0";const prestepHtml=await Templates.render("aiplacement_classifyassist/framework_select",{});this.aiDrawerBodyElement.innerHTML=prestepHtml;const select=this.aiDrawerBodyElement.querySelector("#classify-preselect");select&&(select.innerHTML='<option value="" disabled selected>Loadingâ€¦</option>');try{const calls=Ajax.call([{methodname:"core_competency_list_competency_frameworks",args:{sort:"shortname",order:"ASC",skip:0,context:{contextid:1,instanceid:0}}}]),res=await calls[0],frameworks=Array.isArray(null==res?void 0:res.frameworks)?res.frameworks:Array.isArray(res)?res:[];if(select)if(select.innerHTML="",frameworks.length){const ph=document.createElement("option");ph.value="",ph.disabled=!0,ph.selected=!0,ph.textContent="Select Competency Framework...",select.appendChild(ph),frameworks.forEach((fw=>{const opt=document.createElement("option");opt.value=String(fw.id),opt.textContent=fw.shortname||fw.name||fw.idnumber||"Framework #".concat(fw.id),opt.dataset.shortname=fw.shortname||"",opt.dataset.idnumber=fw.idnumber||"",select.appendChild(opt)}))}else select.innerHTML='<option value="" disabled selected>No frameworks found</option>'}catch(error){select&&(select.innerHTML='<option value="" disabled selected>Failed to load frameworks</option>'),Notification.exception(error)}const continueBtn=this.aiDrawerBodyElement.querySelector('[data-action="continue"]'),sel=this.aiDrawerBodyElement.querySelector("#classify-preselect");if(continueBtn){continueBtn.disabled=!0;const updateContinueState=()=>{var _sel$options$sel$sele;const hasValue=!(!sel||!sel.value||null!==(_sel$options$sel$sele=sel.options[sel.selectedIndex])&&void 0!==_sel$options$sel$sele&&_sel$options$sel$sele.disabled);continueBtn.disabled=!hasValue};sel&&sel.addEventListener("change",updateContinueState),updateContinueState(),continueBtn.addEventListener("click",(e=>{e.preventDefault(),continueBtn.disabled||(this._selectedFrameworkId=sel&&sel.value?Number(sel.value):null,this._selectedFrameworkShortname=sel&&sel.selectedOptions[0]?sel.selectedOptions[0].dataset.shortname||sel.selectedOptions[0].textContent.trim():null,this.sendClassification(prompt))}))}const cancelBtn=this.aiDrawerBodyElement.querySelector('[data-action="cancel"]');cancelBtn&&cancelBtn.addEventListener("click",(e=>{e.preventDefault(),this.setRequestCancelled(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""}))}async sendClassification(prompt){if(!prompt)return Notification.error("No prompt provided.");this.aiDrawerBodyElement.dataset.cancelled="0";const loadingHtml=await Templates.render("aiplacement_classifyassist/loading",{});this.aiDrawerBodyElement.innerHTML=loadingHtml;const cancelBtn=this.aiDrawerBodyElement.querySelector('[data-action="cancel"]');cancelBtn&&cancelBtn.addEventListener("click",(e=>{e.preventDefault(),this.setRequestCancelled(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""})),console.log(prompt);try{const calls=Ajax.call([{methodname:"aiplacement_classifyassist_classify_text",args:{contextid:this.contextId,prompttext:prompt,selectedframeworkid:this._selectedFrameworkId||0,selectedframeworkshortname:this._selectedFrameworkShortname||""}}]),result=await calls[0];if(this.isRequestCancelled())return void(this.aiDrawerBodyElement.dataset.cancelled="0");console.log(result);const{frameworkid:frameworkid,frameworkshortname:frameworkshortname,tasks:tasks,skills:skills,knowledge:knowledge}=result,uniqid="resp-"+Math.random().toString(36).substr(2,9),heading=await Str.get_string("classifyheading","aiplacement_classifyassist"),responseHtml=await Templates.render("aiplacement_classifyassist/response",{heading:heading,action:heading,uniqid:uniqid,frameworkid:frameworkid,frameworkshortname:frameworkshortname,tasks:tasks,skills:skills,knowledge:knowledge});this.aiDrawerBodyElement.innerHTML=responseHtml;const regen=this.aiDrawerBodyElement.querySelector('[data-action="regenerate"]');regen&&regen.addEventListener("click",(e=>{e.preventDefault(),this.sendClassification(prompt)}))}catch(error){if(!this.isRequestCancelled()){const errorHtml=await Templates.render("aiplacement_classifyassist/error",{});this.aiDrawerBodyElement.innerHTML=errorHtml,Notification.exception(error)}}finally{this.aiDrawerBodyElement.dataset.cancelled="0"}}}}));

//# sourceMappingURL=placement.min.js.map