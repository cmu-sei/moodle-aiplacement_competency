define("aiplacement_competency/placement",["aiplacement_courseassist/placement","core/templates","core/ajax","core/notification","core/str"],(function(Base,Templates,Ajax,Notification,Str){return class extends Base{constructor(userId,contextId){super(userId,contextId),this.aiDrawerElement=document.querySelector("#ai-classify-drawer"),this.aiDrawerBodyElement=this.aiDrawerElement.querySelector(".ai-drawer-body"),this.aiDrawerCloseElement=this.aiDrawerElement.querySelector("#ai-classify-drawer-close"),this.aiDrawerCloseElement&&this.aiDrawerCloseElement.addEventListener("click",(e=>{e.preventDefault(),this.closeAIDrawer()})),this._levels=[],this.registerExtraListener()}registerExtraListener(){document.addEventListener("click",(async e=>{const retryBtn=e.target.closest('[data-action="retry"]');if(retryBtn&&this.aiDrawerElement.contains(retryBtn)){e.preventDefault(),retryBtn.disabled=!0;try{const ta=document.querySelector("#id_introeditor")||document.querySelector('[name="intro[text]"]'),ce=document.querySelector('[id^="id_introeditor"][contenteditable="true"]'),prompt=(ta&&"string"==typeof ta.value?ta.value.trim():"")||(ce&&ce.textContent?ce.textContent.trim():"");if(!prompt){const errorHtml=await Templates.render("aiplacement_competency/error",{});return void(this.aiDrawerBodyElement.innerHTML=errorHtml)}await this.showSelectFramework(prompt)}finally{retryBtn.disabled=!1}return}if(!e.target.closest('[data-action="classify"]'))return;e.preventDefault(),this.openAIDrawer();const ta=document.querySelector("#id_introeditor")||document.querySelector('[name="intro[text]"]'),ce=document.querySelector('[id^="id_introeditor"][contenteditable="true"]'),prompt=(ta&&"string"==typeof ta.value?ta.value.trim():"")||(ce&&ce.textContent?ce.textContent.trim():"");if(prompt)await this.showSelectFramework(prompt);else{Str.get_string("notify_empty_description","aiplacement_competency").catch((()=>"No content found to classify.")).then((msg=>Notification.addNotification({type:"error",message:msg})));const errorHtml=await Templates.render("aiplacement_competency/error",{});this.aiDrawerBodyElement.innerHTML=errorHtml}}))}async showSelectFramework(prompt){this.aiDrawerBodyElement.dataset.cancelled="0";const prestepHtml=await Templates.render("aiplacement_competency/framework_select",{});this.aiDrawerBodyElement.innerHTML=prestepHtml;const select=this.aiDrawerBodyElement.querySelector("#classify-preselect");select&&(select.innerHTML='<option value="" disabled selected>Loadingâ€¦</option>');try{const calls=Ajax.call([{methodname:"core_competency_list_competency_frameworks",args:{sort:"shortname",order:"ASC",skip:0,context:{contextid:1,instanceid:0}}}]),res=await calls[0],frameworks=Array.isArray(null==res?void 0:res.frameworks)?res.frameworks:Array.isArray(res)?res:[];if(select)if(select.innerHTML="",frameworks.length){const ph=document.createElement("option");ph.value="",ph.disabled=!0,ph.selected=!0,ph.textContent="Select Competency Framework...",select.appendChild(ph),frameworks.forEach((fw=>{const opt=document.createElement("option");opt.value=String(fw.id),opt.textContent=fw.shortname||fw.name||fw.idnumber||"Framework #".concat(fw.id),opt.dataset.shortname=fw.shortname||"",opt.dataset.idnumber=fw.idnumber||"",select.appendChild(opt)}))}else select.innerHTML='<option value="" disabled selected>No frameworks found</option>'}catch(error){select&&(select.innerHTML='<option value="" disabled selected>Failed to load frameworks</option>'),Notification.exception(error)}const continueBtn=this.aiDrawerBodyElement.querySelector('[data-action="continue"]'),sel=this.aiDrawerBodyElement.querySelector("#classify-preselect"),backBtn=this.aiDrawerBodyElement.querySelector('[data-action="back"]'),cancelBtn=this.aiDrawerBodyElement.querySelector('[data-action="cancel"]');if(continueBtn){continueBtn.disabled=!0;const updateContinueState=()=>{var _sel$options$sel$sele;const hasValue=!(!sel||!sel.value||null!==(_sel$options$sel$sele=sel.options[sel.selectedIndex])&&void 0!==_sel$options$sel$sele&&_sel$options$sel$sele.disabled);continueBtn.disabled=!hasValue};sel&&sel.addEventListener("change",updateContinueState),updateContinueState(),continueBtn.addEventListener("click",(e=>{if(e.preventDefault(),continueBtn.disabled)return;const opt=sel&&sel.selectedOptions?sel.selectedOptions[0]:null;this._selectedFrameworkId=sel&&sel.value?Number(sel.value):null,this._selectedFrameworkShortname=opt?opt.dataset.shortname||opt.textContent.trim():null;const selectedFramework={id:this._selectedFrameworkId,shortname:this._selectedFrameworkShortname};this._selectedFramework=selectedFramework,this.showLevels(prompt,selectedFramework)}))}backBtn&&backBtn.addEventListener("click",(e=>{e.preventDefault(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""})),cancelBtn&&cancelBtn.addEventListener("click",(e=>{e.preventDefault(),this.setRequestCancelled(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""}))}async showLevels(prompt,framework){this.aiDrawerBodyElement.dataset.cancelled="0";const html=await Templates.render("aiplacement_competency/levels",{options:[]});this.aiDrawerBodyElement.innerHTML=html;let competencies=[];try{const args={filters:[{column:"competencyframeworkid",value:String(framework.id)},{column:"parentid",value:"0"}],sort:"shortname",order:"ASC",skip:0,limit:0},requests=Ajax.call([{methodname:"core_competency_list_competencies",args:args}]),res=await requests[0];competencies=Array.isArray(null==res?void 0:res.competencies)?res.competencies:Array.isArray(res)?res:[],competencies=competencies.filter((c=>0===Number(c.parentid||0)))}catch(error){var _this$aiDrawerBodyEle;null===(_this$aiDrawerBodyEle=this.aiDrawerBodyElement.querySelector(".ai-prestep"))||void 0===_this$aiDrawerBodyEle||_this$aiDrawerBodyEle.insertAdjacentHTML("afterbegin",'<div class="alert alert-danger mb-3">Failed to load levels.</div>'),Notification.exception(error),competencies=[]}const options=competencies.map((c=>{var _c$competencyname$tri,_c$competencyname;const label=((c.shortname||"").trim()||c.competencyname&&(null===(_c$competencyname$tri=(_c$competencyname=c.competencyname).trim)||void 0===_c$competencyname$tri?void 0:_c$competencyname$tri.call(_c$competencyname))||(c.idnumber||"").trim()||c.description&&c.description.replace(/<[^>]+>/g,"").trim()||"#".concat(c.id)).replace(/\b[A-Z]{4,}\b/g,(w=>w.charAt(0)+w.slice(1).toLowerCase()));return{id:"level-".concat(c.shortname),value:String(c.shortname),label:label}})),finalHtml=await Templates.render("aiplacement_competency/levels",{options:options});this.aiDrawerBodyElement.innerHTML=finalHtml;const cancelBtn=this.aiDrawerBodyElement.querySelector('[data-action="cancel"]'),backBtn=this.aiDrawerBodyElement.querySelector('[data-action="back"]'),continueBtn=this.aiDrawerBodyElement.querySelector('[data-action="continue"]'),boxes=this.aiDrawerBodyElement.querySelectorAll('input[name="classify-levels"]');if(Array.isArray(this._selectedLevels)&&this._selectedLevels.length){const set=new Set(this._selectedLevels.map(String));boxes.forEach((b=>{b.checked=set.has(b.value)}))}const updateContinue=()=>{const anyChecked=Array.from(boxes).some((b=>b.checked));continueBtn&&(continueBtn.disabled=!anyChecked)};boxes.forEach((b=>b.addEventListener("change",updateContinue))),updateContinue(),continueBtn&&continueBtn.addEventListener("click",(e=>{if(e.preventDefault(),continueBtn.disabled)return;const selectedLevels=Array.from(boxes).filter((b=>b.checked)).map((b=>b.value));this._selectedLevels=selectedLevels,this.sendClassification(prompt,framework,selectedLevels)})),backBtn&&backBtn.addEventListener("click",(e=>{e.preventDefault(),this.showSelectFramework(prompt)})),cancelBtn&&cancelBtn.addEventListener("click",(e=>{e.preventDefault(),this.setRequestCancelled(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""}))}async sendClassification(prompt,framework,levels){this.aiDrawerBodyElement.dataset.cancelled="0";const loadingHtml=await Templates.render("aiplacement_competency/loading",{});this.aiDrawerBodyElement.innerHTML=loadingHtml;const cancelBtn=this.aiDrawerBodyElement.querySelector('[data-action="cancel"]');cancelBtn&&cancelBtn.addEventListener("click",(e=>{e.preventDefault(),this.setRequestCancelled(),this.toggleAIDrawer(),this.aiDrawerBodyElement.innerHTML=""}));try{const fw=framework||this._selectedFramework||{id:this._selectedFrameworkId,shortname:this._selectedFrameworkShortname},rawSelectedLevels=Array.isArray(levels)&&levels.length?levels:Array.isArray(this._selectedLevels)&&this._selectedLevels.length?this._selectedLevels:[],selectedLevels=[...new Set(rawSelectedLevels.map((s=>String(s).trim().replace(/\s+/g," "))).filter(Boolean).map((s=>s.toLowerCase())))],calls=Ajax.call([{methodname:"aiplacement_competency_classify_text",args:{contextid:this.contextId,prompttext:prompt,selectedframeworkid:(null==fw?void 0:fw.id)||0,selectedframeworkshortname:(null==fw?void 0:fw.shortname)||"",levels:selectedLevels}}]),result=await calls[0];if(this.isRequestCancelled())return void(this.aiDrawerBodyElement.dataset.cancelled="0");const{frameworkid:frameworkid,frameworkshortname:frameworkshortname,usedlevels:usedlevels=[],competencies:competencies=[]}=result,uniqid="resp-"+Math.random().toString(36).substr(2,9),heading=await Str.get_string("classifyheading","aiplacement_competency"),responseHtml=await Templates.render("aiplacement_competency/response",{heading:heading,action:heading,uniqid:uniqid,frameworkid:frameworkid,frameworkshortname:frameworkshortname,usedlevels:usedlevels,competencies:competencies});this.aiDrawerBodyElement.innerHTML=responseHtml;const regen=this.aiDrawerBodyElement.querySelector('[data-action="regenerate"]');regen&&regen.addEventListener("click",(e=>{e.preventDefault(),this.sendClassification(prompt,fw,selectedLevels)}))}catch(error){if(!this.isRequestCancelled()){const errorHtml=await Templates.render("aiplacement_competency/error",{});this.aiDrawerBodyElement.innerHTML=errorHtml,Notification.exception(error)}}finally{this.aiDrawerBodyElement.dataset.cancelled="0"}}}}));

//# sourceMappingURL=placement.min.js.map