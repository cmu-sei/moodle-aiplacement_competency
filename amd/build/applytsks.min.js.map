{"version":3,"file":"applytsks.min.js","sources":["../src/applytsks.js"],"sourcesContent":["define([\n  'core/modal',\n  'core/modal_factory',\n  'core/modal_events',\n  'core/templates',\n  'core/str',\n  'core/notification',\n  'core/ajax'\n], function(Modal, ModalFactory, ModalEvents, Templates, Str, Notification, Ajax) {\n\n  var toArray = function(nl){ return Array.prototype.slice.call(nl || []); };\n  var MAP = { tasks: 'tasks', skills: 'skills', knowledge: 'knowledge' };\n\n  var getModalAPI = function() {\n    var hasNew = Modal && typeof Modal.create === 'function';\n    return {\n      create: hasNew ? Modal.create.bind(Modal)\n                     : (ModalFactory && ModalFactory.create.bind(ModalFactory)),\n      types:  (hasNew && (Modal.types || Modal.TYPE)) ||\n              (ModalFactory && ModalFactory.types) ||\n              null\n    };\n  };\n\n  var extractFromResponse = function(root){\n    var out = { tasks: [], skills: [], knowledge: [] };\n    if (!root) { return out; }\n    var dl = root.querySelector('dl');\n    if (!dl) { return out; }\n\n    toArray(dl.querySelectorAll('dt')).forEach(function(dt){\n      var key = MAP[(dt.textContent || '').trim().toLowerCase()];\n      if (!key) { return; }\n      var dd = dt.nextElementSibling;\n      if (!dd || dd.tagName.toLowerCase() !== 'dd') { return; }\n\n      out[key] = toArray(dd.querySelectorAll('li'))\n        .map(function(li){ return (li.innerText || '').trim(); })\n        .filter(Boolean)\n        .filter(function(s){ return s.toLowerCase() !== 'none'; });\n    });\n    return out;\n  };\n\n  var collectChecked = function(root){\n    var pick = function(section){\n      var sel = '.aiplacement-applytsks-section[data-section=\"' + section + '\"] input[type=\"checkbox\"]:checked';\n      return toArray(root.querySelectorAll(sel)).map(function(cb){\n        var row = cb.closest('label'); var span = row && row.querySelector('span');\n        return span ? span.textContent.trim() : null;\n      }).filter(Boolean);\n    };\n    return { tasks: pick('tasks'), skills: pick('skills'), knowledge: pick('knowledge') };\n  };\n\n  var attachControls = function($root){\n    $root.on('click', '[data-action=\"selectall\"]', function(e){\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) { toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = true; }); }\n    });\n    $root.on('click', '[data-action=\"clearall\"]', function(e){\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) { toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = false; }); }\n    });\n\n    $root.on('click', '[data-action=\"apply-inline\"]', function(e){\n      e.preventDefault();\n      $root.trigger(ModalEvents.save);\n    });\n  };\n\n    var openModal = function(values){\n        return Str.get_string('applytsks_title', 'aiplacement_classifyassist').then(function(title){\n            return Templates.render('aiplacement_classifyassist/applytsks_modal', {\n            tasks: values.tasks || [],\n            skills: values.skills || [],\n            knowledge: values.knowledge || [],\n            hastasks: !!(values.tasks && values.tasks.length),\n            hasskills: !!(values.skills && values.skills.length),\n            hasknowledge: !!(values.knowledge && values.knowledge.length)\n            }).then(function(html, js){\n            var api = getModalAPI();\n            if (!api.create) { throw new Error('No modal API available'); }\n\n            var opts = { title: title, body: html, large: true };\n            if (api.types && api.types.SAVE_CANCEL) { opts.type = api.types.SAVE_CANCEL; }\n\n            return api.create(opts).then(function(modal){\n                if (js) { Templates.runTemplateJS(js); }\n                attachControls(modal.getRoot());\n\n                return new Promise(function(resolve, reject){\n                modal.getRoot().on(ModalEvents.save, function(){\n                    try {\n                    var root = modal.getRoot()[0];\n                    var picked = collectChecked(root);\n                    modal.getRoot().data('selection', picked);\n                    sessionStorage.setItem('aiplacement_applytsks:last', JSON.stringify(picked));\n                    console.log('Saved selection:', picked);\n\n                    //List competencies\n                    const calls = Ajax.call([{\n                      methodname: 'core_competency_list_competencies',\n                    }]);\n\n                    calls[0].done(function(response) {\n                      console.log(\"Competencies response:\", response);\n                    }).fail(function(err) {\n                      console.error(\"Competencies error:\", err);\n                    });\n\n                    resolve(collectChecked(root));\n                    modal.hide();\n                    } catch (err) {\n                    Notification.exception(err);\n                    reject(err);\n                    }\n                });\n                modal.show();\n                });\n            });\n            });\n        });\n    };\n\n  var dispatchApply = function(payload, context){\n    var ev;\n    try { ev = new CustomEvent('aiplacement_classifyassist:apply', { detail: payload, bubbles: true }); }\n    catch (e) { ev = document.createEvent('CustomEvent'); ev.initCustomEvent('aiplacement_classifyassist:apply', true, false, payload); }\n    (context || document).dispatchEvent(ev);\n  };\n\n  var handleClick = function(btn){\n    var card = btn.closest('.card-text.content');\n    if (!card) { return; }\n    var content = card.querySelector('.course-assist-response-content');\n    var values = extractFromResponse(content);\n\n    openModal(values).then(function(edited){\n      if (!edited) { return; }\n      var contentEl = card.querySelector('[id^=\"course-assist-response-content-\"]');\n      var uniqid = contentEl ? contentEl.id : null;\n      dispatchApply({ uniqid: uniqid, action: 'applytsks', values: edited }, contentEl || document);\n    });\n  };\n\n  var init = function(){\n    document.addEventListener('click', function(e){\n      var btn = e.target.closest('button[data-action=\"applytsks\"]');\n      if (!btn) { return; }\n      e.preventDefault();\n      handleClick(btn);\n    }, { passive: false });\n  };\n\n  return { init: init };\n});\n"],"names":["define","Modal","ModalFactory","ModalEvents","Templates","Str","Notification","Ajax","toArray","nl","Array","prototype","slice","call","MAP","tasks","skills","knowledge","collectChecked","root","pick","section","sel","querySelectorAll","map","cb","row","closest","span","querySelector","textContent","trim","filter","Boolean","openModal","values","get_string","then","title","render","hastasks","length","hasskills","hasknowledge","html","js","hasNew","api","create","bind","types","TYPE","Error","opts","body","large","SAVE_CANCEL","type","modal","$root","runTemplateJS","getRoot","on","e","preventDefault","sec","currentTarget","forEach","checked","trigger","save","Promise","resolve","reject","picked","data","sessionStorage","setItem","JSON","stringify","console","log","methodname","done","response","fail","err","error","hide","exception","show","handleClick","btn","card","out","dl","dt","key","toLowerCase","dd","nextElementSibling","tagName","li","innerText","s","extractFromResponse","edited","contentEl","payload","context","ev","CustomEvent","detail","bubbles","document","createEvent","initCustomEvent","dispatchEvent","dispatchApply","uniqid","id","action","init","addEventListener","target","passive"],"mappings":"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"}