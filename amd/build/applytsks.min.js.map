{"version":3,"file":"applytsks.min.js","sources":["../src/applytsks.js"],"sourcesContent":["define([\n  'core/modal',\n  'core/modal_factory',\n  'core/modal_events',\n  'core/templates',\n  'core/str',\n  'core/ajax',\n  'jquery',\n  'core/notification'\n], function(Modal, ModalFactory, ModalEvents, Templates, Str, Ajax, $, Notification) {\n\n  var toArray = function(nl) { return Array.prototype.slice.call(nl || []); };\n  var MAP = { tasks: 'tasks', skills: 'skills', knowledge: 'knowledge' };\n\n  var RELOAD_COURSE_KEY ='aiplacement:coursePostReloadNotices';\n  var RELOAD_CM_KEY = 'aiplacement:cmPostReloadNotices';\n\n  // Save the competencies that were added, exists, or failed to be added to the course\n  function stashCourseNotices(added, exists, failed) {\n    try {\n      sessionStorage.setItem(RELOAD_COURSE_KEY, JSON.stringify({\n        added: added || [], exists: exists || [], failed: failed || []\n      }));\n    } catch (e) {}\n  }\n\n    // Save the competencies that were added, exists, or failed to be added to the activity\n  function stashCmNotices(added, exists, failed) {\n    try {\n      sessionStorage.setItem(RELOAD_CM_KEY, JSON.stringify({\n        added: added || [], exists: exists || [], failed: failed || []\n      }));\n    } catch (e) {}\n  }\n\n  // Show notices with added, exists, or failed competencies with green, yellow, and red notifications\n  function showNoticesFrom(key, headings) {\n    var raw = null;\n    try { raw = sessionStorage.getItem(key); } catch (e) {}\n    if (!raw) {\n      return;\n    }\n    try { sessionStorage.removeItem(key); } catch (e) {}\n\n    var data = {};\n    try { data = JSON.parse(raw) || {}; } catch (e) {}\n    var added  = Array.isArray(data.added)  ? data.added  : [];\n    var exists = Array.isArray(data.exists) ? data.exists : [];\n    var failed = Array.isArray(data.failed) ? data.failed : [];\n\n    var jobs = [];\n\n    if (added.length) {\n      jobs.push(\n        Str.get_string(headings.added.key, headings.added.comp, { count: added.length })\n          .catch(function(){ return headings.added.fallback(added.length); })\n          .then(function(h) { Notification.addNotification({ type: 'success', message: '<div>' + esc(h) + '</div>' + renderList(added) }); })\n      );\n    }\n    if (exists.length) {\n      jobs.push(\n        Str.get_string(headings.exists.key, headings.exists.comp, { count: exists.length })\n          .catch(function(){ return headings.exists.fallback(exists.length); })\n          .then(function(h) { Notification.addNotification({ type: 'warning', message: '<div>' + esc(h) + '</div>' + renderList(exists) }); })\n      );\n    }\n    if (failed.length) {\n      jobs.push(\n        Str.get_string(headings.failed.key, headings.failed.comp, { count: failed.length })\n          .catch(function(){ return headings.failed.fallback(failed.length); })\n          .then(function(h) { Notification.addNotification({ type: 'error', message: '<div>' + esc(h) + '</div>' + renderList(failed) }); })\n      );\n    }\n    Promise.allSettled(jobs);\n  }\n\n  // Call these after load to show course notifications once the page refreshes\n  function showPostReloadCourseNoticesIfAny() {\n    showNoticesFrom(RELOAD_COURSE_KEY, {\n      added : { key: 'notify_course_added_heading',  comp:'aiplacement_classifyassist', fallback: c => 'Course competencies added (' + c + ')' },\n      exists: { key: 'notify_course_exists_heading', comp:'aiplacement_classifyassist', fallback: c => 'Already in course (' + c + ')' },\n      failed: { key: 'notify_course_failed_heading', comp:'aiplacement_classifyassist', fallback: c => 'Failed to add to course (does not match selected framework) (' + c + ')' }\n    });\n  }\n\n  // Call these after load to show activity notifications once the page refreshes\n  function showPostReloadCmNoticesIfAny() {\n    showNoticesFrom(RELOAD_CM_KEY, {\n      added : { key: 'notify_cm_added_heading',  comp:'aiplacement_classifyassist', fallback: c => 'Added to activity (' + c + ')' },\n      exists: { key: 'notify_cm_exists_heading', comp:'aiplacement_classifyassist', fallback: c => 'Already linked to activity (' + c + ')' },\n      failed: { key: 'notify_cm_failed_heading', comp:'aiplacement_classifyassist', fallback: c => 'Failed to link to activity (' + c + ')' }\n    });\n  }\n\n  var getModalAPI = function() {\n    var hasNew = Modal && typeof Modal.create === 'function';\n    return {\n      create: hasNew ? Modal.create.bind(Modal)\n        : (ModalFactory && ModalFactory.create.bind(ModalFactory)),\n      types: (hasNew && (Modal.types || Modal.TYPE)) ||\n        (ModalFactory && ModalFactory.types) ||\n        null\n    };\n  };\n\n  // Get the AI response\n  var extractFromResponse = function(root) {\n    var out = { tasks: [], skills: [], knowledge: [] };\n    if (!root) { return out; }\n    var dl = root.querySelector('dl');\n    if (!dl) { return out; }\n\n    toArray(dl.querySelectorAll('dt')).forEach(function(dt) {\n      var key = MAP[(dt.textContent || '').trim().toLowerCase()];\n      if (!key) { return; }\n      var dd = dt.nextElementSibling;\n      if (!dd || dd.tagName.toLowerCase() !== 'dd') { return; }\n\n      out[key] = toArray(dd.querySelectorAll('li'))\n        .map(function(li) { return (li.innerText || '').trim(); })\n        .filter(Boolean)\n        .filter(function(s) { return s.toLowerCase() !== 'none'; });\n    });\n    return out;\n  };\n\n  // Get the user checked competencies from the modal\n  var collectChecked = function(root) {\n    var pick = function(section) {\n      var sel = '.aiplacement-applytsks-section[data-section=\"' + section + '\"] input[type=\"checkbox\"]:checked';\n      return toArray(root.querySelectorAll(sel)).map(function(cb) {\n        var row = cb.closest('label');\n        var span = row && row.querySelector('span');\n        return span ? span.textContent.trim() : null;\n      }).filter(Boolean);\n    };\n    return { tasks: pick('tasks'), skills: pick('skills'), knowledge: pick('knowledge') };\n  };\n\n  // Add checkboxes, select all, clear all\n  var attachControls = function($root) {\n    $root.on('click', '[data-action=\"selectall\"]', function(e) {\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) {\n        toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb) { cb.checked = true; });\n      }\n    });\n    $root.on('click', '[data-action=\"clearall\"]', function(e) {\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) {\n        toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb) { cb.checked = false; });\n      }\n    });\n\n    $root.on('click', '[data-action=\"apply-inline\"]', function(e) {\n      e.preventDefault();\n      $root.trigger(ModalEvents.save);\n    });\n  };\n\n  // Get course id from activity body\n  var getCourseIdFromBody = function() {\n    var cls = (document.body && document.body.className) || '';\n    var m = cls.match(/(?:^|\\s)course-(\\d+)(?:\\s|$)/);\n    return m ? parseInt(m[1], 10) : null;\n  };\n\n  // Add user selected competencies from the modal to the course\n  var addCompetenciesToCourse = function(courseId, competencyIds) {\n    if (!courseId || !Array.isArray(competencyIds) || competencyIds.length === 0) {\n      return Promise.resolve([]);\n    }\n\n    var calls = competencyIds.map(function(id) {\n      return {\n        methodname: 'core_competency_add_competency_to_course',\n        args: { courseid: courseId, competencyid: id }\n      };\n    });\n\n    var reqs = Ajax.call(calls);\n\n    return Promise.all(reqs.map(function(p, idx) {\n      return Promise.resolve(p)\n        .then(function(res) { return { id: competencyIds[idx], result: res }; })\n        .catch(function(err) { return { id: competencyIds[idx], error: err }; });\n    }));\n  };\n\n  // Escape text for safe HTML output\n  var esc = function (s) {\n    return String(s)\n      .replace(/&/g, '&amp;').replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;').replace(/\"/g, '&quot;')\n      .replace(/'/g, '&#39;');\n  };\n\n  // Render a bullet list from an array of strings.\n  var renderList = function (items) {\n    return '<ul class=\"mb-0 mt-1\">' +\n      items.map(function (t) { return '<li>' + esc(t) + '</li>'; }).join('') +\n    '</ul>';\n  };\n\n  var norm = function(s) {\n    return (s === null || s === undefined ? '' : String(s)).toLowerCase().trim();\n  };\n\n  // Matches the competencies selected from the modal with the system's competencies\n  var matchPickedToCompetencies = function(frameworkId, picked) {\n    return new Promise(function(resolve, reject) {\n      var calls = Ajax.call([{\n        methodname: 'core_competency_list_competencies',\n        args: {\n          filters: [\n            { column: 'competencyframeworkid', value: String(frameworkId) }\n          ],\n          sort: 'shortname',\n          order: 'ASC',\n          skip: 0,\n          limit: 0\n        }\n      }]);\n\n      calls[0].done(function(response) {\n        var list = Array.isArray(response) ? response : (response.competencies || []);\n        var byIdnumber = new Map();\n        var byShortExact = new Map();\n        list.forEach(function(c) {\n          var idn = norm(c.idnumber);\n          var sn = norm(c.shortname);\n          if (idn) { byIdnumber.set(idn, c); }\n          if (sn) { byShortExact.set(sn, c); }\n        });\n\n        var inputs = []\n          .concat(picked.tasks || [])\n          .concat(picked.skills || [])\n          .concat(picked.knowledge || []);\n\n        var matches = inputs.map(function(str) {\n          var original = str || '';\n          var parts = original.split(' - ');\n          var code = norm(parts[0] || '');\n          var name = norm(parts.slice(1).join(' - '));\n          var comp = null;\n\n          // Get idnumber\n          if (code && byIdnumber.has(code)) {\n            comp = byIdnumber.get(code);\n          }\n          // Get shortname\n          if (!comp && name && byShortExact.has(name)) {\n            comp = byShortExact.get(name);\n          }\n          // Get name and description\n          if (!comp && name) {\n            comp = list.find(function(c) { return norm(c.description).includes(name); });\n          }\n          // Get name and shortname\n          if (!comp && name) {\n            comp = list.find(function(c) { return norm(c.shortname).includes(name); });\n          }\n\n          return comp ?\n            { input: original, id: comp.id, idnumber: comp.idnumber, shortname: comp.shortname } :\n            { input: original, id: null };\n        });\n\n        var matchedIds = matches\n          .filter(function(m) { return m.id !== null && m.id !== undefined; })\n          .map(function(m) { return m.id; });\n\n        resolve({ matches: matches, matchedIds: matchedIds, list: list });\n      }).fail(function(err) {\n        reject(err);\n      });\n    });\n  };\n\n  // Grab cmid from the URL (activity edit page uses ?update=<cmid>)\n  function getCmidFromUrl() {\n    var qs = new URLSearchParams(window.location.search);\n    return Number(qs.get('update') || 0);\n  }\n\n  function addToModule(cmid, competencyId) {\n    return Ajax.call([{\n      methodname: 'aiplacement_classifyassist_add_cm_competency',\n      args: { cmid: cmid, competencyid: competencyId }\n    }])[0]; // returns a Promise\n  }\n\n  // Modal that shows the ai response competencies to the user, here the user will be able to select which should be added to the course\n  var openModal = function(values) {\n    return Str.get_string('applytsks_title', 'aiplacement_classifyassist').then(function(title) {\n      return Templates.render('aiplacement_classifyassist/applytsks_modal', {\n        tasks: values.tasks || [],\n        skills: values.skills || [],\n        knowledge: values.knowledge || [],\n        hastasks: !!(values.tasks && values.tasks.length),\n        hasskills: !!(values.skills && values.skills.length),\n        hasknowledge: !!(values.knowledge && values.knowledge.length)\n      }).then(function(html, js) {\n        var api = getModalAPI();\n        if (!api.create) { throw new Error('No modal API available'); }\n\n        var opts = { title: title, body: html, large: true };\n        if (api.types && api.types.SAVE_CANCEL) { opts.type = api.types.SAVE_CANCEL; }\n\n        return api.create(opts).then(function(modal) {\n          if (js) { Templates.runTemplateJS(js); }\n          attachControls(modal.getRoot());\n\n          return new Promise(function(resolve, reject) {\n            modal.getRoot().on(ModalEvents.save, function() {\n              try {\n                var root = modal.getRoot()[0];\n                var picked = collectChecked(root);\n                modal.getRoot().data('selection', picked);\n                sessionStorage.setItem('aiplacement_applytsks:last', JSON.stringify(picked));\n                console.log('Selection saved:', picked);\n\n                var frameworkId = String($('dd[data-frameworkid]').data('frameworkid') || '0');\n\n                matchPickedToCompetencies(frameworkId, picked).then(function(res) {\n                  var sel = modal.getRoot().data('selection') || {};\n                  sel.matchedCompetencyIds = res.matchedIds;\n                  modal.getRoot().data('selection', sel);\n\n                  // Split into matched vs unmatched.\n                  var all = Array.isArray(res.matches) ? res.matches : [];\n                  var matched = all.filter(function (m) {\n                    return m && m.id !== null && m.id !== undefined;\n                  });\n                  var unmatched = all.filter(function (m) {\n                    return !m || m.id === null || m.id === undefined;\n                  });\n\n                  var unmatchedLabels = unmatched\n                    .map(function(m){ return (m && m.input) ? String(m.input).trim() : ''; })\n                    .filter(Boolean);\n\n\n                  console.log('Competency list:', res.list);\n                  console.log('Matched (with ids):', matched);\n                  console.log('Unmatched (no id):', unmatchedLabels);\n                  console.log('Matched competency IDs:', res.matchedIds);\n\n                  var courseId = getCourseIdFromBody();\n                  var pickedNow = collectChecked(root);\n\n                  if (!courseId) {\n                    Str.get_string('notify_nocourseid', 'aiplacement_classifyassist').then(function(msg) {\n                      Notification.addNotification({ type: 'warning', message: msg });\n                    });\n                    resolve(pickedNow);\n                    modal.hide();\n                    return;\n                  }\n\n                  // Add competencies to course\n                  addCompetenciesToCourse(courseId, res.matchedIds).then(function(outcomes) {\n                    var byId = new Map();\n                    matched.forEach(function(m) { if (m.id) { byId.set(m.id, m); } });\n\n                    var added = [], exists = [], failed = [];\n                    outcomes.forEach(function(o) {\n                      if (o.error) { failed.push(o.id); return; }\n                      if (o.result === false) {\n                        exists.push(o.id);\n                      } else if (o.result === true || o.result === 1 || o.result === '1') {\n                        added.push(o.id);\n                      } else {\n                        (o.result ? added : exists).push(o.id);\n                      }\n                    });\n\n                    var nameOf = function(id) {\n                      var m = byId.get(id);\n                      if (!m) { return 'ID ' + id; }\n                      return m.shortname || m.input || ('ID ' + id);\n                    };\n\n                    var addedNames  = added.map(nameOf);\n                    var existsNames = exists.map(nameOf);\n                    var failedNames = failed.map(nameOf).concat(unmatchedLabels);\n\n                    stashCourseNotices(addedNames, existsNames, failedNames);\n\n                    const cmid = getCmidFromUrl();\n                    const toLink = Array.from(new Set([].concat(added, exists))); // ids to ensure linked at CM level\n\n                    var linkPromise = Promise.resolve();\n                    if (cmid > 0 && toLink.length) {\n                      // Build id â†’ display name map for post-reload messages.\n                      var byIdName = new Map();\n                      matched.forEach(function(m) {\n                        if (m && m.id) {\n                          byIdName.set(m.id, m.shortname || m.input || ('ID ' + m.id));\n                        }\n                      });\n\n                      linkPromise = Promise.all(toLink.map(function(id) {\n                        return addToModule(cmid, id)\n                          .then(function(ok) {\n                            return { id: id, status: ok ? 'added' : 'exists' };\n                          })\n                          .catch(function() {\n                            return { id: id, status: 'failed' };\n                          });\n                      })).then(function(results) {\n                        var addedIds = [], existsIds = [], failedIds = [];\n                        results.forEach(function(r) {\n                          if (r.status === 'added') {\n                            addedIds.push(r.id);\n                          } else if (r.status === 'exists') {\n                            existsIds.push(r.id);\n                          } else {\n                            failedIds.push(r.id);\n                          }\n                        });\n\n                        var cmAddedNames  = addedIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); });\n                        var cmExistsNames = existsIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); });\n                        var cmFailedNames = failedIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); });\n\n                        // Stash ACTIVITY notices (separate bucket)\n                        stashCmNotices(cmAddedNames, cmExistsNames, cmFailedNames);\n                      });\n                    }\n                    linkPromise.then(function(){\n                      window.location.reload();\n                    });\n                  }).catch(function(err) {\n                    console.error('Failed to add competencies to course:', err);\n                    Notification.exception(err);\n                    resolve(pickedNow);\n                    modal.hide();\n                  });\n                }).catch(function(err) {\n                  console.error('Failed to list/match competencies:', err);\n                  reject(err);\n                });\n              } catch (err) {\n                console.error(err);\n                reject(err);\n              }\n            });\n            modal.show();\n          });\n        });\n      });\n    });\n  };\n\n  var dispatchApply = function(payload, context) {\n    var ev;\n    try {\n      ev = new CustomEvent('aiplacement_classifyassist:apply', { detail: payload, bubbles: true });\n    } catch (e) {\n      ev = document.createEvent('CustomEvent');\n      ev.initCustomEvent('aiplacement_classifyassist:apply', true, false, payload);\n    }\n    (context || document).dispatchEvent(ev);\n  };\n\n  var handleClick = function(btn) {\n    var card = btn.closest('.card-text.content');\n    if (!card) { return; }\n    var content = card.querySelector('.course-assist-response-content');\n    var values = extractFromResponse(content);\n\n    openModal(values).then(function(edited) {\n      if (!edited) { return; }\n      var contentEl = card.querySelector('[id^=\"course-assist-response-content-\"]');\n      var uniqid = contentEl ? contentEl.id : null;\n\n      dispatchApply(\n        { uniqid: uniqid, action: 'applytsks', values: edited },\n        contentEl || document\n      );\n    });\n  };\n\n  var init = function() {\n    document.addEventListener('click', function(e) {\n      var btn = e.target.closest('button[data-action=\"applytsks\"]');\n      if (!btn) { return; }\n      e.preventDefault();\n      handleClick(btn);\n    }, { passive: false });\n  };\n\n  // Show notices on page reload\n  showPostReloadCourseNoticesIfAny();\n  showPostReloadCmNoticesIfAny();\n\n  return { init: init };\n});\n"],"names":["define","Modal","ModalFactory","ModalEvents","Templates","Str","Ajax","$","Notification","toArray","nl","Array","prototype","slice","call","MAP","tasks","skills","knowledge","showNoticesFrom","key","headings","raw","sessionStorage","getItem","e","removeItem","data","JSON","parse","added","isArray","exists","failed","jobs","length","push","get_string","comp","count","catch","fallback","then","h","addNotification","type","message","esc","renderList","Promise","allSettled","collectChecked","root","pick","section","sel","querySelectorAll","map","cb","row","closest","span","querySelector","textContent","trim","filter","Boolean","s","String","replace","items","t","join","norm","toLowerCase","openModal","values","title","render","hastasks","hasskills","hasknowledge","html","js","hasNew","api","create","bind","types","TYPE","Error","opts","body","large","SAVE_CANCEL","modal","$root","runTemplateJS","getRoot","on","preventDefault","sec","currentTarget","forEach","checked","trigger","save","resolve","reject","picked","setItem","stringify","console","log","frameworkId","methodname","args","filters","column","value","sort","order","skip","limit","done","response","list","competencies","byIdnumber","Map","byShortExact","c","idn","idnumber","sn","shortname","set","matches","concat","str","original","parts","split","code","name","has","get","find","description","includes","input","id","matchedIds","m","undefined","fail","err","matchPickedToCompetencies","res","matchedCompetencyIds","all","matched","unmatched","unmatchedLabels","courseId","document","className","match","parseInt","pickedNow","msg","hide","competencyIds","calls","courseid","competencyid","reqs","p","idx","result","error","addCompetenciesToCourse","outcomes","byId","o","nameOf","stashCourseNotices","cmid","qs","URLSearchParams","window","location","search","Number","toLink","from","Set","linkPromise","byIdName","competencyId","addToModule","ok","status","results","addedIds","existsIds","failedIds","r","stashCmNotices","reload","exception","show","handleClick","btn","card","out","dl","dt","dd","nextElementSibling","tagName","li","innerText","extractFromResponse","edited","contentEl","payload","context","ev","CustomEvent","detail","bubbles","createEvent","initCustomEvent","dispatchEvent","dispatchApply","uniqid","action","init","addEventListener","target","passive"],"mappings":"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"}