{"version":3,"file":"applytsks.min.js","sources":["../src/applytsks.js"],"sourcesContent":["define([\n  'core/modal',\n  'core/modal_factory',\n  'core/modal_events',\n  'core/templates',\n  'core/str',\n  'core/notification',\n], function(Modal, ModalFactory, ModalEvents, Templates, Str, Notification) {\n\n  var toArray = function(nl){ return Array.prototype.slice.call(nl || []); };\n  var MAP = { tasks: 'tasks', skills: 'skills', knowledge: 'knowledge' };\n\n  var getModalAPI = function() {\n    var hasNew = Modal && typeof Modal.create === 'function';\n    return {\n      create: hasNew ? Modal.create.bind(Modal)\n                     : (ModalFactory && ModalFactory.create.bind(ModalFactory)),\n      types:  (hasNew && (Modal.types || Modal.TYPE)) ||\n              (ModalFactory && ModalFactory.types) ||\n              null\n    };\n  };\n\n  var extractFromResponse = function(root){\n    var out = { tasks: [], skills: [], knowledge: [] };\n    if (!root) { return out; }\n    var dl = root.querySelector('dl');\n    if (!dl) { return out; }\n\n    toArray(dl.querySelectorAll('dt')).forEach(function(dt){\n      var key = MAP[(dt.textContent || '').trim().toLowerCase()];\n      if (!key) { return; }\n      var dd = dt.nextElementSibling;\n      if (!dd || dd.tagName.toLowerCase() !== 'dd') { return; }\n\n      out[key] = toArray(dd.querySelectorAll('li'))\n        .map(function(li){ return (li.innerText || '').trim(); })\n        .filter(Boolean)\n        .filter(function(s){ return s.toLowerCase() !== 'none'; });\n    });\n    return out;\n  };\n\n  var collectChecked = function(root){\n    var pick = function(section){\n      var sel = '.aiplacement-applytsks-section[data-section=\"' + section + '\"] input[type=\"checkbox\"]:checked';\n      return toArray(root.querySelectorAll(sel)).map(function(cb){\n        var row = cb.closest('label'); var span = row && row.querySelector('span');\n        return span ? span.textContent.trim() : null;\n      }).filter(Boolean);\n    };\n    return { tasks: pick('tasks'), skills: pick('skills'), knowledge: pick('knowledge') };\n  };\n\n  var attachControls = function($root){\n    $root.on('click', '[data-action=\"selectall\"]', function(e){\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) { toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = true; }); }\n    });\n    $root.on('click', '[data-action=\"clearall\"]', function(e){\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applytsks-section');\n      if (sec) { toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = false; }); }\n    });\n\n    $root.on('click', '[data-action=\"apply-inline\"]', function(e){\n      e.preventDefault();\n      $root.trigger(ModalEvents.save);\n    });\n  };\n\n    var openModal = function(values){\n        return Str.get_string('applytsks_title', 'aiplacement_classifyassist').then(function(title){\n            return Templates.render('aiplacement_classifyassist/applytsks_modal', {\n            tasks: values.tasks || [],\n            skills: values.skills || [],\n            knowledge: values.knowledge || [],\n            hastasks: !!(values.tasks && values.tasks.length),\n            hasskills: !!(values.skills && values.skills.length),\n            hasknowledge: !!(values.knowledge && values.knowledge.length)\n            }).then(function(html, js){\n            var api = getModalAPI();\n            if (!api.create) { throw new Error('No modal API available'); }\n\n            var opts = { title: title, body: html, large: true };\n            if (api.types && api.types.SAVE_CANCEL) { opts.type = api.types.SAVE_CANCEL; }\n\n            return api.create(opts).then(function(modal){\n                if (js) { Templates.runTemplateJS(js); }\n                attachControls(modal.getRoot());\n\n                return new Promise(function(resolve, reject){\n                modal.getRoot().on(ModalEvents.save, function(){\n                    try {\n                    var root = modal.getRoot()[0];\n                    resolve(collectChecked(root));\n                    modal.hide();\n                    } catch (err) {\n                    Notification.exception(err);\n                    reject(err);\n                    }\n                });\n                modal.show();\n                });\n            });\n            });\n        });\n    };\n\n  var dispatchApply = function(payload, context){\n    var ev;\n    try { ev = new CustomEvent('aiplacement_classifyassist:apply', { detail: payload, bubbles: true }); }\n    catch (e) { ev = document.createEvent('CustomEvent'); ev.initCustomEvent('aiplacement_classifyassist:apply', true, false, payload); }\n    (context || document).dispatchEvent(ev);\n  };\n\n  var handleClick = function(btn){\n    var card = btn.closest('.card-text.content');\n    if (!card) { return; }\n    var content = card.querySelector('.course-assist-response-content');\n    var values = extractFromResponse(content);\n\n    openModal(values).then(function(edited){\n      if (!edited) { return; }\n      var contentEl = card.querySelector('[id^=\"course-assist-response-content-\"]');\n      var uniqid = contentEl ? contentEl.id : null;\n      dispatchApply({ uniqid: uniqid, action: 'applytsks', values: edited }, contentEl || document);\n    });\n  };\n\n  var init = function(){\n    document.addEventListener('click', function(e){\n      var btn = e.target.closest('button[data-action=\"applytsks\"]');\n      if (!btn) { return; }\n      e.preventDefault();\n      handleClick(btn);\n    }, { passive: false });\n  };\n\n  return { init: init };\n});\n"],"names":["define","Modal","ModalFactory","ModalEvents","Templates","Str","Notification","toArray","nl","Array","prototype","slice","call","MAP","tasks","skills","knowledge","openModal","values","get_string","then","title","render","hastasks","length","hasskills","hasknowledge","html","js","hasNew","api","create","bind","types","TYPE","Error","opts","body","large","SAVE_CANCEL","type","modal","$root","runTemplateJS","getRoot","on","e","preventDefault","sec","currentTarget","closest","querySelectorAll","forEach","cb","checked","trigger","save","Promise","resolve","reject","root","pick","section","sel","map","row","span","querySelector","textContent","trim","filter","Boolean","collectChecked","hide","err","exception","show","handleClick","btn","card","out","dl","dt","key","toLowerCase","dd","nextElementSibling","tagName","li","innerText","s","extractFromResponse","edited","contentEl","payload","context","ev","CustomEvent","detail","bubbles","document","createEvent","initCustomEvent","dispatchEvent","dispatchApply","uniqid","id","action","init","addEventListener","target","passive"],"mappings":"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"}