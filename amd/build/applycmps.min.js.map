{"version":3,"file":"applycmps.min.js","sources":["../src/applycmps.js"],"sourcesContent":["define([\n  'core/modal',\n  'core/modal_factory',\n  'core/modal_events',\n  'core/templates',\n  'core/str',\n  'core/ajax',\n  'jquery',\n  'core/notification'\n], function(Modal, ModalFactory, ModalEvents, Templates, Str, Ajax, $, Notification) {\n\n  var toArray = function(nl) { return Array.prototype.slice.call(nl || []); };\n\n  var RELOAD_COURSE_KEY = 'aiplacement:coursePostReloadNotices';\n  var RELOAD_CM_KEY     = 'aiplacement:cmPostReloadNotices';\n\n  // Save the competencies that were added, exists, or failed to be added to the course\n  function stashCourseNotices(added, exists, failed) {\n    try {\n      sessionStorage.setItem(RELOAD_COURSE_KEY, JSON.stringify({\n        added: added || [], exists: exists || [], failed: failed || []\n      }));\n    } catch (e) {}\n  }\n  // Save the competencies that were added, exists, or failed to be added to the activity\n  function stashCmNotices(added, exists, failed) {\n    try {\n      sessionStorage.setItem(RELOAD_CM_KEY, JSON.stringify({\n        added: added || [], exists: exists || [], failed: failed || []\n      }));\n    } catch (e) {}\n  }\n\n  // Show notices with added, exists, or failed competencies with green, yellow, and red notifications\n  function showNoticesFrom(key, headings) {\n    var raw = null;\n    try { raw = sessionStorage.getItem(key); } catch (e) {}\n    if (!raw) {\n      return;\n    }\n    try { sessionStorage.removeItem(key); } catch (e) {}\n\n    var data = {};\n    try { data = JSON.parse(raw) || {}; } catch (e) {}\n    var added  = Array.isArray(data.added)  ? data.added  : [];\n    var exists = Array.isArray(data.exists) ? data.exists : [];\n    var failed = Array.isArray(data.failed) ? data.failed : [];\n\n    var jobs = [];\n    var esc = function (s) {\n      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')\n        .replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');\n    };\n    var renderList = function (items) {\n      return '<ul class=\"mb-0 mt-1\">' +\n        items.map(function (t) { return '<li>' + esc(t) + '</li>'; }).join('') +\n      '</ul>';\n    };\n\n    if (added.length) {\n      jobs.push(\n        Str.get_string(headings.added.key, headings.added.comp, { count: added.length })\n          .catch(function(){ return headings.added.fallback(added.length); })\n          .then(function(h) { Notification.addNotification({ type: 'success', message: '<div>' + esc(h) + '</div>' + renderList(added) }); })\n      );\n    }\n    if (exists.length) {\n      jobs.push(\n        Str.get_string(headings.exists.key, headings.exists.comp, { count: exists.length })\n          .catch(function(){ return headings.exists.fallback(exists.length); })\n          .then(function(h) { Notification.addNotification({ type: 'warning', message: '<div>' + esc(h) + '</div>' + renderList(exists) }); })\n      );\n    }\n    if (failed.length) {\n      jobs.push(\n        Str.get_string(headings.failed.key, headings.failed.comp, { count: failed.length })\n          .catch(function(){ return headings.failed.fallback(failed.length); })\n          .then(function(h) { Notification.addNotification({ type: 'error', message: '<div>' + esc(h) + '</div>' + renderList(failed) }); })\n      );\n    }\n    Promise.allSettled(jobs);\n  }\n\n  // Call these after load to show course notifications once the page refreshes\n  function showPostReloadCourseNoticesIfAny() {\n    showNoticesFrom(RELOAD_COURSE_KEY, {\n      added : { key: 'notify_course_added_heading',  comp:'aiplacement_competency', fallback: c => 'Course competencies added (' + c + ')' },\n      exists: { key: 'notify_course_exists_heading', comp:'aiplacement_competency', fallback: c => 'Already in course (' + c + ')' },\n      failed: { key: 'notify_course_failed_heading', comp:'aiplacement_competency', fallback: c => 'Failed to add to course (does not match selected framework) (' + c + ')' }\n    });\n  }\n\n  // Call these after load to show activity notifications once the page refreshes\n  function showPostReloadCmNoticesIfAny() {\n    showNoticesFrom(RELOAD_CM_KEY, {\n      added : { key: 'notify_cm_added_heading',  comp:'aiplacement_competency', fallback: c => 'Added to activity (' + c + ')' },\n      exists: { key: 'notify_cm_exists_heading', comp:'aiplacement_competency', fallback: c => 'Already linked to activity (' + c + ')' },\n      failed: { key: 'notify_cm_failed_heading', comp:'aiplacement_competency', fallback: c => 'Failed to link to activity (' + c + ')' }\n    });\n  }\n\n  var getModalAPI = function() {\n    var hasNew = Modal && typeof Modal.create === 'function';\n    return {\n      create: hasNew ? Modal.create.bind(Modal)\n        : (ModalFactory && ModalFactory.create.bind(ModalFactory)),\n      types: (hasNew && (Modal.types || Modal.TYPE)) ||\n        (ModalFactory && ModalFactory.types) ||\n        null\n    };\n  };\n\n  // Get the AI response\n  var extractFromResponse = function(root) {\n    var out = { competencies: [] };\n    if (!root) {\n      return out;\n    }\n\n    var dd = root.querySelector('dd[data-section=\"competencies\"]');\n    if (!dd) {\n      return out;\n    }\n\n    out.competencies = toArray(dd.querySelectorAll('li'))\n      .map(function(li) { return (li.innerText || '').trim(); })\n      .filter(Boolean)\n      .filter(function(s) { return s.toLowerCase() !== 'none'; });\n\n    return out;\n  };\n\n  // Get the user checked competencies from the modal\n  var collectChecked = function(root) {\n    var sel = '.aiplacement-applycmps-section[data-section=\"competencies\"] input[type=\"checkbox\"]:checked';\n    var arr = toArray(root.querySelectorAll(sel)).map(function(cb) {\n      var row = cb.closest('label');\n      var span = row && row.querySelector('span');\n      return span ? span.textContent.trim() : null;\n    }).filter(Boolean);\n    return { competencies: arr };\n  };\n\n  // Add checkboxes, select all, clear all\n  var attachControls = function($root) {\n    $root.on('click', '[data-action=\"selectall\"]', function(e) {\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applycmps-section');\n      if (sec) {\n        toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = true; });\n      }\n    });\n    $root.on('click', '[data-action=\"clearall\"]', function(e) {\n      e.preventDefault();\n      var sec = e.currentTarget.closest('.aiplacement-applycmps-section');\n      if (sec) {\n        toArray(sec.querySelectorAll('input[type=\"checkbox\"]')).forEach(function(cb){ cb.checked = false; });\n      }\n    });\n    $root.on('click', '[data-action=\"apply-inline\"]', function(e) {\n      e.preventDefault();\n      $root.trigger(ModalEvents.save);\n    });\n  };\n\n  var norm = function(s) {\n    return (s === null ? '' : String(s)).toLowerCase().trim();\n  };\n\n  // Matches the competencies selected from the modal with the system's competencies\n  var matchPickedToCompetencies = function(frameworkId, picked) {\n    return new Promise(function(resolve, reject) {\n      var calls = Ajax.call([{\n        methodname: 'core_competency_list_competencies',\n        args: {\n          filters: [{ column: 'competencyframeworkid', value: String(frameworkId) }],\n          sort: 'shortname', order: 'ASC', skip: 0, limit: 0\n        }\n      }]);\n\n      calls[0].done(function(response) {\n        var list = Array.isArray(response) ? response : (response.competencies || []);\n        var byIdnumber = new Map();\n        var byShortExact = new Map();\n        list.forEach(function(c) {\n          var idn = norm(c.idnumber);\n          var sn  = norm(c.shortname);\n          if (idn) {\n            byIdnumber.set(idn, c);\n          }\n          if (sn)  {\n            byShortExact.set(sn, c);\n          }\n        });\n\n        var inputs = [].concat(picked.competencies || []);\n        var matches = inputs.map(function(str) {\n          var original = str || '';\n          var parts = original.split(' - ');\n          var code = norm(parts[0] || '');\n          var name = norm(parts.slice(1).join(' - '));\n          var comp = null;\n\n          if (code && byIdnumber.has(code)) {\n            comp = byIdnumber.get(code);\n          }\n\n          if (!comp && name && byShortExact.has(name)) {\n            comp = byShortExact.get(name);\n          }\n\n          if (!comp && name) {\n            comp = list.find(function(c) {\n              return norm(c.description).includes(name);\n            });\n          }\n\n          if (!comp && name) {\n            comp = list.find(function(c) {\n              return norm(c.shortname).includes(name);\n            });\n          }\n                    return comp ?\n            { input: original, id: comp.id, idnumber: comp.idnumber, shortname: comp.shortname } :\n            { input: original, id: null };\n        });\n\n        var matchedIds = matches.filter(function(m){ return m.id !== null; }).map(function(m){ return m.id; });\n        resolve({ matches: matches, matchedIds: matchedIds, list: list });\n      }).fail(reject);\n    });\n  };\n  function getCourseIdFromBody() {\n    var cls = (document.body && document.body.className) || '';\n    var m = cls.match(/(?:^|\\s)course-(\\d+)(?:\\s|$)/);\n    return m ? parseInt(m[1], 10) : null;\n  }\n\n  // Grab cmid from the URL (activity edit page uses ?update=<cmid>)\n  function getCmidFromUrl() {\n    var qs = new URLSearchParams(window.location.search);\n    return Number(qs.get('update') || 0);\n  }\n\n  function addToModule(cmid, competencyId) {\n    return Ajax.call([{\n      methodname: 'aiplacement_competency_add_cm_competency',\n      args: { cmid: cmid, competencyid: competencyId }\n    }])[0];\n  }\n\n  // Modal that shows the ai response competencies to the user, here the user will be able to select which should be added to the course\n  var openModal = function(values) {\n    return Str.get_string('applycmps_title', 'aiplacement_competency').then(function(title) {\n      return Templates.render('aiplacement_competency/applycmps_modal', {\n        competencies: values.competencies || [],\n        hascompetencies: !!(values.competencies && values.competencies.length)\n      }).then(function(html, js) {\n        var api = getModalAPI();\n        if (!api.create) {\n          throw new Error('No modal API available');\n        }\n\n        var opts = { title: title, body: html, large: true };\n        if (api.types && api.types.SAVE_CANCEL) {\n          opts.type = api.types.SAVE_CANCEL;\n        }\n\n        return api.create(opts).then(function(modal) {\n          if (js) {\n            Templates.runTemplateJS(js);\n          }\n          attachControls(modal.getRoot());\n\n          return new Promise(function(resolve, reject) {\n            modal.getRoot().on(ModalEvents.save, function() {\n              try {\n                var root = modal.getRoot()[0];\n                var picked = collectChecked(root);\n                modal.getRoot().data('selection', picked);\n                sessionStorage.setItem('aiplacement_applycmps:last', JSON.stringify(picked));\n\n                var frameworkId = String($('dd[data-frameworkid]').data('frameworkid') || '0');\n\n                matchPickedToCompetencies(frameworkId, picked).then(function(res) {\n                  var sel = modal.getRoot().data('selection') || {};\n                  sel.matchedCompetencyIds = res.matchedIds;\n                  modal.getRoot().data('selection', sel);\n\n                  var all = Array.isArray(res.matches) ? res.matches : [];\n                  var matched   = all.filter(function(m){ return m && m.id !== null; });\n                  var unmatched = all.filter(function(m){ return !m || m.id === null; });\n                  var unmatchedLabels = unmatched.map(function(m){ return (m && m.input) ? String(m.input).trim() : ''; }).filter(Boolean);\n\n                  var courseId = getCourseIdFromBody();\n                  if (!courseId) {\n                    Str.get_string('notify_nocourseid', 'aiplacement_competency').then(function(msg) {\n                      Notification.addNotification({ type: 'warning', message: msg });\n                    });\n                    resolve(picked);\n                    modal.hide();\n                    return;\n                  }\n\n                  // Add to course\n                  var calls = res.matchedIds.map(function(id) {\n                    return { methodname: 'core_competency_add_competency_to_course', args: { courseid: courseId, competencyid: id } };\n                  });\n                  var reqs = Ajax.call(calls);\n                  Promise.all(reqs.map(function(p, idx) {\n                    return Promise.resolve(p).then(function(r){ return { id: res.matchedIds[idx], result: r }; })\n                      .catch(function(e){ return { id: res.matchedIds[idx], error: e }; });\n                  })).then(function(outcomes){\n                    var byId = new Map();\n                    matched.forEach(function(m) {\n                      if (m.id) {\n                        byId.set(m.id, m);\n                      }\n                    });\n                    var added=[], exists=[], failed=[];\n                    outcomes.forEach(function(o){\n                     if (o.error) {\n                        failed.push(o.id);\n                        return;\n                      }\n\n                      if (o.result === false) {\n                        exists.push(o.id);\n                      } else if (o.result === true || o.result === 1 || o.result === '1') {\n                        added.push(o.id);\n                      } else {\n                        (o.result ? added : exists).push(o.id);\n                      }\n\n                    });\n\n                    var nameOf = function(id){ var m = byId.get(id); return m ? (m.shortname || m.input || ('ID ' + id)) : ('ID ' + id); };\n                    stashCourseNotices(added.map(nameOf), exists.map(nameOf), failed.map(nameOf).concat(unmatchedLabels));\n\n                    // Also link to CM if we're editing a module\n                    var cmid = getCmidFromUrl();\n                    var toLink = Array.from(new Set([].concat(added, exists)));\n                    var linkPromise = Promise.resolve();\n                    if (cmid > 0 && toLink.length) {\n                      var byIdName = new Map();\n                      matched.forEach(function(m){\n                        if (m && m.id) {\n                          byIdName.set(m.id, m.shortname || m.input || ('ID ' + m.id));\n                        }\n                      });\n                      linkPromise = Promise.all(toLink.map(function(id){\n                        return addToModule(cmid, id).then(function(ok){ return { id:id, status: ok ? 'added' : 'exists' }; })\n                          .catch(function(){ return { id:id, status:'failed' }; });\n                      })).then(function(results){\n                        var addedIds=[], existsIds=[], failedIds=[];\n                        results.forEach(function(r){\n                          if (r.status === 'added') {\n                            addedIds.push(r.id);\n                          } else if (r.status === 'exists') {\n                            existsIds.push(r.id);\n                          } else {\n                            failedIds.push(r.id);\n                          }\n                        });\n                        stashCmNotices(\n                          addedIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); }),\n                          existsIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); }),\n                          failedIds.map(function(id){ return byIdName.get(id) || ('ID ' + id); })\n                        );\n                      });\n                    }\n                    linkPromise.then(function(){ window.location.reload(); });\n                  }).catch(function(err){\n                    Notification.exception(err);\n                    resolve(picked);\n                    modal.hide();\n                  });\n                }).catch(reject);\n              } catch (err) {\n                reject(err);\n              }\n            });\n            modal.show();\n          });\n        });\n      });\n    });\n  };\n\n  var dispatchApply = function(payload, context) {\n    var ev;\n    try {\n      ev = new CustomEvent('aiplacement_competency:apply', { detail: payload, bubbles: true });\n    } catch (e) {\n      ev = document.createEvent('CustomEvent');\n      ev.initCustomEvent('aiplacement_competency:apply', true, false, payload);\n    }\n    (context || document).dispatchEvent(ev);\n  };\n\n  var handleClick = function(btn) {\n    var card = btn.closest('.card-text.content');\n    if (!card) {\n      return;\n    }\n    var content = card.querySelector('.course-assist-response-content');\n    var values = extractFromResponse(content); // { competencies: [...] }\n    openModal(values).then(function(edited) {\n      if (!edited) {\n        return;\n      }\n      var contentEl = card.querySelector('[id^=\"course-assist-response-content-\"]');\n      var uniqid = contentEl ? contentEl.id : null;\n      dispatchApply({ uniqid: uniqid, action: 'applycmps', values: edited }, contentEl || document);\n    });\n  };\n\n  var init = function() {\n    document.addEventListener('click', function(e) {\n      var btn = e.target.closest('button[data-action=\"applycmps\"]');\n      if (!btn) {\n        return;\n      }\n      e.preventDefault();\n      handleClick(btn);\n    }, { passive: false });\n  };\n\n  // Show notices after reloads\n  showPostReloadCourseNoticesIfAny();\n  showPostReloadCmNoticesIfAny();\n\n  return { init: init };\n});\n"],"names":["define","Modal","ModalFactory","ModalEvents","Templates","Str","Ajax","$","Notification","toArray","nl","Array","prototype","slice","call","showNoticesFrom","key","headings","raw","sessionStorage","getItem","e","removeItem","data","JSON","parse","added","isArray","exists","failed","jobs","esc","s","String","replace","renderList","items","map","t","join","length","push","get_string","comp","count","catch","fallback","then","h","addNotification","type","message","Promise","allSettled","norm","toLowerCase","trim","openModal","values","title","render","competencies","hascompetencies","html","js","hasNew","api","create","bind","types","TYPE","Error","opts","body","large","SAVE_CANCEL","modal","$root","runTemplateJS","getRoot","on","preventDefault","sec","currentTarget","closest","querySelectorAll","forEach","cb","checked","trigger","save","resolve","reject","picked","root","row","span","querySelector","textContent","filter","Boolean","collectChecked","setItem","stringify","frameworkId","methodname","args","filters","column","value","sort","order","skip","limit","done","response","list","byIdnumber","Map","byShortExact","c","idn","idnumber","sn","shortname","set","matches","concat","str","original","parts","split","code","name","has","get","find","description","includes","input","id","matchedIds","m","fail","matchPickedToCompetencies","res","sel","matchedCompetencyIds","all","matched","unmatched","unmatchedLabels","courseId","document","className","match","parseInt","msg","hide","calls","courseid","competencyid","reqs","p","idx","r","result","error","outcomes","byId","o","nameOf","stashCourseNotices","qs","cmid","URLSearchParams","window","location","search","Number","toLink","from","Set","linkPromise","byIdName","competencyId","addToModule","ok","status","results","addedIds","existsIds","failedIds","stashCmNotices","reload","err","exception","show","handleClick","btn","card","out","dd","li","innerText","extractFromResponse","edited","contentEl","payload","context","ev","CustomEvent","detail","bubbles","createEvent","initCustomEvent","dispatchEvent","dispatchApply","uniqid","action","init","addEventListener","target","passive"],"mappings":"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"}