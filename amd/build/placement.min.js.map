{"version":3,"file":"placement.min.js","sources":["../src/placement.js"],"sourcesContent":["define([\n    'aiplacement_courseassist/placement',\n    'core/templates',\n    'core/ajax',\n    'core/notification',\n    'core/str'\n], function(Base, Templates, Ajax, Notification, Str) {\n\n    const SELECTOR_CLASSIFY   = '[data-action=\"classify\"]';\n    const SELECTOR_CANCEL     = '[data-action=\"cancel\"]';\n    const SELECTOR_CONTINUE   = '[data-action=\"continue\"]';\n    const SELECTOR_PRESELECT  = '#classify-preselect';\n    const ID_CLOSE_BTN        = '#ai-classify-drawer-close';\n\n    return class ClassifyPlacement extends Base {\n        constructor(userId, contextId) {\n            super(userId, contextId);\n\n            this.aiDrawerElement     = document.querySelector('#ai-classify-drawer');\n            this.aiDrawerBodyElement = this.aiDrawerElement.querySelector('.ai-drawer-body');\n            this.aiDrawerCloseElement = this.aiDrawerElement.querySelector(ID_CLOSE_BTN);\n            if (this.aiDrawerCloseElement) {\n                this.aiDrawerCloseElement.addEventListener('click', e => {\n                    e.preventDefault();\n                    this.closeAIDrawer();\n                });\n            }\n\n            this.registerExtraListener();\n        }\n\n        registerExtraListener() {\n            document.addEventListener('click', async e => {\n                const btn = e.target.closest(SELECTOR_CLASSIFY);\n                if (!btn) {\n                    return;\n                }\n                e.preventDefault();\n                this.openAIDrawer();\n\n                let prompt = '';\n                const tex = document.querySelector('#id_introeditor');\n                if (tex) {\n                    prompt = tex.value.trim();\n                } else {\n                    prompt = this.getTextContent().trim();\n                }\n\n                if (!prompt) {\n                    Notification.error('No content found to classify.');\n                    return;\n                }\n\n                await this.showSelectFramework(prompt);\n            });\n        }\n\n        // Function that shows dropdown with competency framework options\n        async showSelectFramework(prompt) {\n            this.aiDrawerBodyElement.dataset.cancelled = '0';\n\n            const prestepHtml = await Templates.render('aiplacement_classifyassist/framework_select', {});\n            this.aiDrawerBodyElement.innerHTML = prestepHtml;\n\n            const select = this.aiDrawerBodyElement.querySelector(SELECTOR_PRESELECT);\n            if (select) {\n                select.innerHTML = '<option value=\"\" disabled selected>Loadingâ€¦</option>';\n            }\n\n            try {\n                const calls = Ajax.call([{\n                    methodname: 'core_competency_list_competency_frameworks',\n                    args: {\n                        sort: 'shortname',\n                        order: 'ASC',\n                        skip: 0,\n                        context: {\n                            contextid: 1,\n                            instanceid: 0\n                        },\n                    }\n                }]);\n\n                const res = await calls[0];\n                const frameworks = Array.isArray(res?.frameworks) ? res.frameworks\n                                : Array.isArray(res) ? res\n                                : [];\n\n                if (select) {\n                    select.innerHTML = '';\n\n                    if (!frameworks.length) {\n                        select.innerHTML = '<option value=\"\" disabled selected>No frameworks found</option>';\n                    } else {\n                        const ph = document.createElement('option');\n                        ph.value = '';\n                        ph.disabled = true;\n                        ph.selected = true;\n                        ph.textContent = 'Select Competency Framework...';\n                        select.appendChild(ph);\n\n                        frameworks.forEach(fw => {\n                            const opt = document.createElement('option');\n                            opt.value = String(fw.id);\n                            opt.textContent = fw.shortname || fw.name || fw.idnumber || `Framework #${fw.id}`;\n                            opt.dataset.shortname = fw.shortname || '';\n                            opt.dataset.idnumber  = fw.idnumber || '';\n                            select.appendChild(opt);\n                        });\n                    }\n                }\n            } catch (error) {\n                if (select) {\n                    select.innerHTML = '<option value=\"\" disabled selected>Failed to load frameworks</option>';\n                }\n                Notification.exception(error);\n            }\n\n            const continueBtn = this.aiDrawerBodyElement.querySelector(SELECTOR_CONTINUE);\n            const sel = this.aiDrawerBodyElement.querySelector(SELECTOR_PRESELECT);\n\n            if (continueBtn) {\n                continueBtn.disabled = true;\n\n                const updateContinueState = () => {\n                    const hasValue = !!(sel && sel.value && !sel.options[sel.selectedIndex]?.disabled);\n                    continueBtn.disabled = !hasValue;\n                };\n\n                if (sel) {\n                    sel.addEventListener('change', updateContinueState);\n                }\n\n                updateContinueState();\n\n                continueBtn.addEventListener('click', e => {\n                    e.preventDefault();\n                    if (continueBtn.disabled) {\n                        return;\n                    }\n\n                    this._selectedFrameworkId        = sel && sel.value ? Number(sel.value) : null;\n                    this._selectedFrameworkShortname = sel && sel.selectedOptions[0]\n                        ? (sel.selectedOptions[0].dataset.shortname || sel.selectedOptions[0].textContent.trim())\n                        : null;\n\n                    this.sendClassification(prompt);\n                });\n            }\n\n            const cancelBtn = this.aiDrawerBodyElement.querySelector(SELECTOR_CANCEL);\n            if (cancelBtn) {\n                cancelBtn.addEventListener('click', e => {\n                    e.preventDefault();\n                    this.setRequestCancelled();\n                    this.toggleAIDrawer();\n                    this.aiDrawerBodyElement.innerHTML = '';\n                });\n            }\n        }\n\n        async sendClassification(prompt) {\n            if (!prompt) {\n                return Notification.error('No prompt provided.');\n            }\n\n            this.aiDrawerBodyElement.dataset.cancelled = '0';\n\n            const loadingHtml = await Templates.render('aiplacement_classifyassist/loading', {});\n            this.aiDrawerBodyElement.innerHTML = loadingHtml;\n\n            const cancelBtn = this.aiDrawerBodyElement.querySelector(SELECTOR_CANCEL);\n            if (cancelBtn) {\n                cancelBtn.addEventListener('click', e => {\n                    e.preventDefault();\n                    this.setRequestCancelled();\n                    this.toggleAIDrawer();\n                    this.aiDrawerBodyElement.innerHTML = '';\n                });\n            }\n\n            console.log(prompt);\n            try {\n                const calls = Ajax.call([{\n                    methodname: 'aiplacement_classifyassist_classify_text',\n                    args: {\n                        contextid: this.contextId,\n                        prompttext: prompt,\n                        selectedframeworkid: this._selectedFrameworkId || 0,\n                        selectedframeworkshortname: this._selectedFrameworkShortname || ''\n                    }\n                }]);\n\n                const result = await calls[0];\n\n                if (this.isRequestCancelled()) {\n                    this.aiDrawerBodyElement.dataset.cancelled = '0';\n                    return;\n                }\n\n                console.log(result);\n\n                const {frameworkid, frameworkshortname, tasks, skills, knowledge } = result;\n\n                const uniqid  = 'resp-' + Math.random().toString(36).substr(2, 9);\n                const heading = await Str.get_string('classifyheading', 'aiplacement_classifyassist');\n\n                const responseHtml = await Templates.render(\n                    'aiplacement_classifyassist/response',\n                    { heading, action: heading, uniqid, frameworkid, frameworkshortname, tasks, skills, knowledge }\n                );\n\n                this.aiDrawerBodyElement.innerHTML = responseHtml;\n\n                const regen = this.aiDrawerBodyElement.querySelector('[data-action=\"regenerate\"]');\n                if (regen) {\n                    regen.addEventListener('click', e => {\n                        e.preventDefault();\n                        this.sendClassification(prompt);\n                    });\n                }\n\n            } catch (error) {\n                if (!this.isRequestCancelled()) {\n                    const errorHtml = await Templates.render('aiplacement_classifyassist/error', {});\n                    this.aiDrawerBodyElement.innerHTML = errorHtml;\n                    Notification.exception(error);\n                }\n            } finally {\n                this.aiDrawerBodyElement.dataset.cancelled = '0';\n            }\n        }\n    };\n});\n"],"names":["define","Base","Templates","Ajax","Notification","Str","constructor","userId","contextId","aiDrawerElement","document","querySelector","aiDrawerBodyElement","this","aiDrawerCloseElement","addEventListener","e","preventDefault","closeAIDrawer","registerExtraListener","async","target","closest","openAIDrawer","prompt","tex","value","trim","getTextContent","showSelectFramework","error","dataset","cancelled","prestepHtml","render","innerHTML","select","calls","call","methodname","args","sort","order","skip","context","contextid","instanceid","res","frameworks","Array","isArray","length","ph","createElement","disabled","selected","textContent","appendChild","forEach","fw","opt","String","id","shortname","name","idnumber","exception","continueBtn","sel","updateContinueState","hasValue","options","selectedIndex","_sel$options$sel$sele","_selectedFrameworkId","Number","_selectedFrameworkShortname","selectedOptions","sendClassification","cancelBtn","setRequestCancelled","toggleAIDrawer","loadingHtml","console","log","prompttext","selectedframeworkid","selectedframeworkshortname","result","isRequestCancelled","frameworkid","frameworkshortname","tasks","skills","knowledge","uniqid","Math","random","toString","substr","heading","get_string","responseHtml","action","regen","errorHtml"],"mappings":"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"}