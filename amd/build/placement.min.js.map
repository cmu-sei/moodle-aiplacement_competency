{"version":3,"file":"placement.min.js","sources":["../src/placement.js"],"sourcesContent":["define([\n    'aiplacement_courseassist/placement', // Parent class\n    'core/templates',\n    'core/ajax',\n    'core/notification',\n    'core/str'\n], function(Base, Templates, Ajax, Notification, Str) {\n\n    const SELECTOR_CLASSIFY = '[data-action=\"classify\"]';\n    const SELECTOR_CANCEL   = '[data-action=\"cancel\"]';\n    const ID_CLOSE_BTN      = '#ai-classify-drawer-close';\n\n    return class ClassifyPlacement extends Base {\n        constructor(userId, contextId) {\n            super(userId, contextId);\n\n            this.aiDrawerElement     = document.querySelector('#ai-classify-drawer');\n            this.aiDrawerBodyElement = this.aiDrawerElement.querySelector('.ai-drawer-body');\n            this.aiDrawerCloseElement = this.aiDrawerElement.querySelector(ID_CLOSE_BTN);\n            if (this.aiDrawerCloseElement) {\n                this.aiDrawerCloseElement.addEventListener('click', e => {\n                    e.preventDefault();\n                    this.closeAIDrawer();\n                });\n            }\n\n            this.registerExtraListener();\n        }\n\n        registerExtraListener() {\n            document.addEventListener('click', async e => {\n                const btn = e.target.closest(SELECTOR_CLASSIFY);\n                if (!btn) {\n                    return;\n                }\n                e.preventDefault();\n                this.openAIDrawer();\n\n                let prompt = '';\n                const tex = document.querySelector('#id_introeditor');\n                if (tex) {\n                    prompt = tex.value.trim();\n                } else {\n                    prompt = this.getTextContent().trim();\n                }\n\n                if (!prompt) {\n                    Notification.error('No content found to classify.');\n                    return;\n                }\n\n                this.sendClassification(prompt);\n            });\n        }\n\n        async sendClassification(prompt) {\n            if (!prompt) {\n                return Notification.error('No prompt provided.');\n            }\n\n            // Reset any stale cancel state from a previous run.\n            this.aiDrawerBodyElement.dataset.cancelled = '0';\n\n            const loadingHtml = await Templates.render('aiplacement_classifyassist/loading', {});\n            this.aiDrawerBodyElement.innerHTML = loadingHtml;\n\n            // Wire up \"Cancel\" in the loading view.\n            const cancelBtn = this.aiDrawerBodyElement.querySelector(SELECTOR_CANCEL);\n            if (cancelBtn) {\n                cancelBtn.addEventListener('click', e => {\n                    e.preventDefault();\n                    this.setRequestCancelled();   // mark as cancelled\n                    this.toggleAIDrawer();        // close (or reopen) drawer\n                    this.aiDrawerBodyElement.innerHTML = ''; // clear loading UI\n                });\n            }\n\n            try {\n                const calls = Ajax.call([{\n                    methodname: 'aiplacement_classifyassist_classify_text',\n                    args: {\n                        contextid: this.contextId,\n                        prompttext: prompt\n                    }\n                }]);\n\n                const result = await calls[0];\n\n                if (this.isRequestCancelled()) {\n                    this.aiDrawerBodyElement.dataset.cancelled = '0';\n                    return;\n                }\n\n                const {frameworkid, frameworkshortname, tasks, skills, knowledge } = result;\n\n                const uniqid  = 'resp-' + Math.random().toString(36).substr(2, 9);\n                const heading = await Str.get_string('classifyheading', 'aiplacement_classifyassist');\n\n                const responseHtml = await Templates.render(\n                    'aiplacement_classifyassist/response',\n                    { heading, action: heading, uniqid, frameworkid, frameworkshortname, tasks, skills, knowledge }\n                );\n\n                this.aiDrawerBodyElement.innerHTML = responseHtml;\n\n                const regen = this.aiDrawerBodyElement.querySelector('[data-action=\"regenerate\"]');\n                if (regen) {\n                    regen.addEventListener('click', e => {\n                        e.preventDefault();\n                        this.sendClassification(prompt);\n                    });\n                }\n\n            } catch (error) {\n                if (!this.isRequestCancelled()) {\n                    const errorHtml = await Templates.render('aiplacement_classifyassist/error', {});\n                    this.aiDrawerBodyElement.innerHTML = errorHtml;\n                    Notification.exception(error);\n                }\n            } finally {\n                this.aiDrawerBodyElement.dataset.cancelled = '0';\n            }\n        }\n    };\n});\n"],"names":["define","Base","Templates","Ajax","Notification","Str","constructor","userId","contextId","aiDrawerElement","document","querySelector","aiDrawerBodyElement","this","aiDrawerCloseElement","addEventListener","e","preventDefault","closeAIDrawer","registerExtraListener","async","target","closest","openAIDrawer","prompt","tex","value","trim","getTextContent","sendClassification","error","dataset","cancelled","loadingHtml","render","innerHTML","cancelBtn","setRequestCancelled","toggleAIDrawer","calls","call","methodname","args","contextid","prompttext","result","isRequestCancelled","frameworkid","frameworkshortname","tasks","skills","knowledge","uniqid","Math","random","toString","substr","heading","get_string","responseHtml","action","regen","errorHtml","exception"],"mappings":"AAAAA,8CAAO,CACH,qCACA,iBACA,YACA,oBACA,aACD,SAASC,KAAMC,UAAWC,KAAMC,aAAcC,YAMtC,cAAgCJ,KACnCK,YAAYC,OAAQC,iBACVD,OAAQC,gBAETC,gBAAsBC,SAASC,cAAc,4BAC7CC,oBAAsBC,KAAKJ,gBAAgBE,cAAc,wBACzDG,qBAAuBD,KAAKJ,gBAAgBE,cAR/B,6BASdE,KAAKC,2BACAA,qBAAqBC,iBAAiB,SAASC,IAChDA,EAAEC,sBACGC,wBAIRC,wBAGTA,wBACIT,SAASK,iBAAiB,SAASK,MAAAA,QACnBJ,EAAEK,OAAOC,QAvBP,mCA2BdN,EAAEC,sBACGM,mBAEDC,OAAS,SACPC,IAAMf,SAASC,cAAc,mBAE/Ba,OADAC,IACSA,IAAIC,MAAMC,OAEVd,KAAKe,iBAAiBD,OAG9BH,YAKAK,mBAAmBL,QAJpBpB,aAAa0B,MAAM,6DAQNN,YAChBA,cACMpB,aAAa0B,MAAM,4BAIzBlB,oBAAoBmB,QAAQC,UAAY,UAEvCC,kBAAoB/B,UAAUgC,OAAO,qCAAsC,SAC5EtB,oBAAoBuB,UAAYF,kBAG/BG,UAAYvB,KAAKD,oBAAoBD,cA1DzB,0BA2DdyB,WACAA,UAAUrB,iBAAiB,SAASC,IAChCA,EAAEC,sBACGoB,2BACAC,sBACA1B,oBAAoBuB,UAAY,gBAKnCI,MAAQpC,KAAKqC,KAAK,CAAC,CACrBC,WAAY,2CACZC,KAAM,CACFC,UAAW9B,KAAKL,UAChBoC,WAAYpB,WAIdqB,aAAeN,MAAM,MAEvB1B,KAAKiC,sCACAlC,oBAAoBmB,QAAQC,UAAY,WAI3Ce,YAACA,YAADC,mBAAcA,mBAAdC,MAAkCA,MAAlCC,OAAyCA,OAAzCC,UAAiDA,WAAcN,OAE/DO,OAAU,QAAUC,KAAKC,SAASC,SAAS,IAAIC,OAAO,EAAG,GACzDC,cAAgBpD,IAAIqD,WAAW,kBAAmB,8BAElDC,mBAAqBzD,UAAUgC,OACjC,sCACA,CAAEuB,QAAAA,QAASG,OAAQH,QAASL,OAAAA,OAAQL,YAAAA,YAAaC,mBAAAA,mBAAoBC,MAAAA,MAAOC,OAAAA,OAAQC,UAAAA,iBAGnFvC,oBAAoBuB,UAAYwB,mBAE/BE,MAAQhD,KAAKD,oBAAoBD,cAAc,8BACjDkD,OACAA,MAAM9C,iBAAiB,SAASC,IAC5BA,EAAEC,sBACGY,mBAAmBL,WAIlC,MAAOM,WACAjB,KAAKiC,qBAAsB,OACtBgB,gBAAkB5D,UAAUgC,OAAO,mCAAoC,SACxEtB,oBAAoBuB,UAAY2B,UACrC1D,aAAa2D,UAAUjC,qBAGtBlB,oBAAoBmB,QAAQC,UAAY"}